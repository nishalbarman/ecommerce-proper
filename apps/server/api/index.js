"use strict";Object.defineProperty(exports, "__esModule", {value: true});var p=(r=>typeof require<"u"?require:typeof Proxy<"u"?new Proxy(r,{get:(e,t)=>(typeof require<"u"?require:e)[t]}):r)(function(r){if(typeof require<"u")return require.apply(this,arguments);throw Error('Dynamic require of "'+r+'" is not supported')});var j=(r,e)=>()=>(e||r((e={exports:{}}).exports,e),e.exports);var Ct=j((cd,As)=>{var Wa=p("mongoose"),Ha=process.env.MONGO_URI,X=global.mongoose;X||(X=global.mongoose={conn:null,promise:null});async function Ya(){return X.conn||(X.promise||(X.promise=Wa.connect(Ha,{serverSelectionTimeoutMS:6e4,socketTimeoutMS:6e4,bufferCommands:!1})),X.conn=await X.promise),X.conn}As.exports=Ya});var x=j((ld,Ds)=>{var ae=p("mongoose"),_s=new ae.Schema({orderGroupID:{type:String,required:!1},paymentTxnId:{type:String,required:!1},user:{type:ae.Types.ObjectId,ref:"users"},product:{type:ae.Types.ObjectId,ref:"products"},previewImage:{type:String},title:{type:String,required:!0},price:{type:Number,required:!0},shippingPrice:{type:Number,default:0},color:{type:String,required:!1},size:{type:String,required:!1},quantity:{type:Number,default:null},address:{physicalAddress:{fullName:{type:String,required:!0},phone:{type:String,required:!0},landmark:{type:String,required:!1},postalCode:{type:String,required:!0},country:{type:String,required:!0},streetName:{type:String,required:!0},city:{type:String,required:!0},state:{type:String,required:!0}},location:{type:[Number,Number],required:!1}},orderType:{type:String,required:!0,enums:["buy","rent"]},orderStatus:{type:String,default:"On Hold",enums:["On Hold","Pending","On Progress","Accepted","Rejected","Cancelled","On The Way","PickUp Ready","Delivered"]},paymentMode:{type:String,enums:["Prepaid","Cash On Delivery","Cash On Pickup"]},paymentStatus:{type:String,default:"Pending",enums:["Success","Failed","Pending"]},shipmentType:{type:String,required:!1,enums:["self_pickup","delivery_partner"],default:"self_pickup"},rentDays:{type:Number,required:!1,default:void 0},pickupDate:{type:Date,requied:!1,default:null},center:{type:Object,required:!1,default:null},rentPickedUpDate:{type:Date,required:!1,default:null},rentReturnDueDate:{type:Date,default:null},trackingLink:{type:String,default:""}},{timestamps:!0});_s.index({"$**":"text"});var dd=new ae.Schema({user:{type:ae.Types.ObjectId,ref:"users"},orders:[{type:ae.Types.ObjectId,ref:"orders"}]},{timestamps:!0}),Ja=ae.models.orders||ae.model("orders",_s);Ds.exports=Ja});var M=j((fd,ks)=>{var ve=p("mongoose"),{hasOneSpaceBetweenNames:pd,isValidEmail:md,isValidIndianMobileNumber:gd,isValidUrl:yd}=p("custom-validator-renting"),Qa=new ve.Schema({name:{type:String,required:!1,default:""},email:{type:String,required:!0,default:"",unique:!0},mobileNo:{type:String,required:!1},password:{type:String,required:!0},isEmailVerfied:{type:Boolean,default:!1},emailVerifyToken:{type:String,default:""},isMobileNoVerified:{type:Boolean,default:!0},resetToken:{type:String,default:""},role:{type:ve.Types.ObjectId,ref:"roles",default:"698f03e9100596fe285eecbf"},defaultAddress:{type:ve.Types.ObjectId,ref:"addresses"},center:{type:ve.Types.ObjectId,ref:"center_details"},stripeCustomer:{type:Object,required:!1}},{timestamps:!0}),Za=ve.models.users||ve.model("users",Qa);ks.exports=Za});var dt=j((hd,Os)=>{var Xa=p("nodemailer"),en=Xa.createTransport({host:process.env.SENDER_EMAIL_HOST,port:587,tls:{rejectUnauthorized:!1,minVersion:"TLSv1.2"},auth:{user:process.env.SENDER_EMAIL_ADDRESS,pass:process.env.SENDER_EMAIL_PASSWORD}});Os.exports={sendMail:async function(e){await en.sendMail(e)}}});var L=j((bd,Ns)=>{var qe=p("mongoose"),tn=new qe.Schema({user:{type:qe.Types.ObjectId,ref:"users"},product:{type:qe.Types.ObjectId,ref:"products"},variant:{type:qe.Types.ObjectId,ref:"product_variants"},quantity:{type:Number,default:1},rentDays:{type:Number,default:2},productType:{type:String,enum:["buy","rent"],required:!0}},{timestamps:!0}),sn=qe.models.cart||qe.model("cart",tn);Ns.exports=sn});var V=j((Id,Rs)=>{var Ge=p("mongoose"),rn=new Ge.Schema({orderGroupID:{type:String,required:!0},paymentTransactionID:{type:String,required:!0},order:{type:[Ge.Types.ObjectId],ref:"orders",required:!0},user:{type:Ge.Types.ObjectId,ref:"users",required:!0},paymentStatus:{type:String,enum:["Pending","Paid","Failed","COC"]},subTotalPrice:{type:Number,required:!0},shippingPrice:{type:Number,required:!0},totalPrice:{type:Number,required:!0}}),on=Ge.models.payment_transactions||Ge.model("payment_transactions",rn);Rs.exports=on});var me=j((jd,Cs)=>{var lt=p("mongoose"),Es=new lt.Schema({user:{type:lt.Types.ObjectId,ref:"users",required:!0},prefix:{type:String,required:!0},locality:{type:String,required:!0},postalCode:{type:String,required:!0},country:{type:String,required:!0},streetName:{type:String,required:!0},city:{type:String,required:!0},state:{type:String,required:!0},longitude:{type:Number,required:!0},latitude:{type:Number,required:!0},location:{type:{type:String,enum:["Point"],required:!0},coordinates:{type:[Number],required:!0}}},{timestamps:!0});Es.index({location:"2dsphere"});var an=lt.models.addresses||lt.model("addresses",Es);Cs.exports=an});var Mt=j((wd,Ms)=>{var xs=p("memory-cache"),xt=class{static async shipRocketLogin(){try{let e=xs.get("shipRocketAuthToken");if(!e){let s=await(await fetch("https://apiv2.shiprocket.in/v1/external/auth/login",{method:"POST",body:JSON.stringify({email:process.env.SHIPROCKET_EMAIL,password:process.env.SHIPROCKET_PASSWORD})})).json();return xs.put("shipRocketAuthToken",s.token,864e6),s.token}return e}catch(e){throw new Error(e)}}static async createShiprocketOrder(e,t,s,o,a){let i={order_id:e,order_date:new Date().toLocaleDateString(),pickup_location:"Primary",channel_id:t,billing_customer_name:s.name,billing_address:`${o.prefix}, ${o.streetName}, ${o.city}, ${o.state}, ${o.postalCode}`,billing_city:o.city,billing_pincode:o.postalCode,billing_state:o.state,billing_country:o.country,billing_email:s.email,billing_phone:s.mobileNo,shipping_is_billing:!0,order_items:a.order.map(l=>({name:l.title,sku:l.product,units:l.quantity,selling_price:l.price})),payment_method:"Prepaid",sub_total:a.totalPrice,length:10,breadth:15,height:20,weight:2.5},u=await this.shipRocketLogin(),c=await fetch("https://apiv2.shiprocket.in/v1/external/orders/create/adhoc",{method:"POST",headers:{Authorization:`Bearer ${u}`},body:JSON.stringify(i)})}};Ms.exports=xt});var te=j(($d,Vs)=>{var ee=p("mongoose"),{hasOneSpaceBetweenNames:Pd,isValidEmail:Sd,isValidIndianMobileNumber:vd,isValidUrl:qd}=p("custom-validator-renting"),Us=new ee.Schema({previewImage:{type:String,required:!0},title:{type:String,required:!0},category:{type:ee.Types.ObjectId,ref:"categories"},slideImages:{type:Array,required:!0},description:{type:String,required:!0},stars:{type:Number,default:0},totalRatings:{type:Number,default:0},totalFeedbacks:{type:Number,default:0},rentTotalOrders:{type:Number,default:0},buyTotalOrders:{type:Number,default:0},productType:{type:String,enums:["rent","buy","both"],required:!0},shippingPrice:{type:Number,required:!0,default:0},availableStocks:{type:Number,required:!0,default:0},rentingPrice:{type:Number,required:!0},discountedPrice:{type:Number,required:!0},originalPrice:{type:Number},isVariantAvailable:{type:Boolean,default:!1},productVariant:{type:[ee.Types.ObjectId],ref:"product_variants"}},{timestamps:!0,query:{withQuery(r){return this.where(r)},withPagination(r={},e=20,t){return this.where(r).sort({createdAt:"desc"}).skip(t).limit(e)}}});Us.index({"$**":"text"});var nn=new ee.Schema({product:{type:ee.Types.ObjectId,ref:"products"},previewImage:{type:String,required:!0},slideImages:{type:[String],required:!0},size:{type:String,required:!0},color:{type:String,required:!0},availableStocks:{type:Number,required:!0},shippingPrice:{type:Number,required:!0},rentingPrice:{type:Number,required:!0},discountedPrice:{type:Number,required:!0},originalPrice:{type:Number}},{timestamps:!0}),pt=ee.models.products||ee.model("products",Us),Fs=ee.models.product_varients||ee.model("product_variants",nn);pt.schema.path("previewImage").validate({validator:r=>!!r,message:"Invalid Preview Image Url"});pt.schema.path("discountedPrice").validate({validator:r=>r&&!isNaN(parseFloat(r))&&r>0,message:"Discounted Price must be non zero number"});pt.schema.path("slideImages").validate({validator:r=>r&&r.length>=1,message:"Slide Images must contain atleast 1 images"});Fs.schema.path("discountedPrice").validate({validator:r=>r&&!isNaN(parseFloat(r))&&r>0,message:"Discounted Price must be non zero number,"});Vs.exports={Product:pt,ProductVariant:Fs}});var Ls=j((kd,Gs)=>{var{Router:un}=p("express"),Ut=x(),cn=p("stripe")(process.env.STRIPE_SECRET_KEY,{maxNetworkRetries:3}),dn=p("express"),Td=M(),{sendMail:ln}=dt(),pn=L(),{default:Ad}=p("mongoose"),Bs=V(),_d=me(),Dd=Mt(),{Product:mn}=te(),Ks=un(),gn=process.env.STRIPE_ENDPOINT_SECRET;Ks.post("/",dn.raw({type:"application/json"}),async(r,e)=>{console.log("GOT AN REQUEST IN THE STRIPE HOOK -->");try{let t=r.headers["stripe-signature"],s;try{s=cn.webhooks.constructEvent(r.body,t,gn)}catch(o){return console.error(o),e.status(400).send(`Webhook Error: ${o.message}`)}switch(s.type){case"payment_intent.payment_failed":let o=s.data.object;await Ut.updateMany({paymentTxnId:o.metadata.paymentTxnId},{$set:{paymentStatus:"Failed",orderStatus:"Rejected"}}),await Bs.updateOne({paymentTransactionID:o.id},{$set:{paymentStatus:"Failed"}});break;case"payment_intent.succeeded":let a=s.data.object,n=[{$match:{paymentTxnId:a.id}},{$set:{paymentStatus:"Success",orderStatus:"On Progress"}},{$group:{_id:null,productIds:{$addToSet:"$product"},orders:{$push:"$$ROOT"}}},{$lookup:{from:"products",let:{productIds:"$productIds"},pipeline:[{$match:{$expr:{$in:["$_id","$$productIds"]}}},{$set:{buyTotalOrders:{$add:["$buyTotalOrders",1]}}}],as:"updatedProducts"}},{$project:{orders:1,updatedProducts:1}}],i=await Ut.aggregate(n);if(await Bs.updateOne({paymentTransactionID:a.id},{$set:{paymentStatus:"Paid"}}),await pn.deleteMany({_id:{$in:a.metadata.cartProductIds.split(",")}}),i.length>0){let{orders:u,updatedProducts:c}=i[0],l=u.map(y=>({updateOne:{filter:{_id:y._id},update:{$set:{paymentStatus:"Success",orderStatus:"On Progress"}}}})),m=c.map(y=>({updateOne:{filter:{_id:y._id},update:{$inc:{buyTotalOrders:1}}}}));await Ut.bulkWrite(l),await mn.bulkWrite(m)}await ln({from:`"Rent Karo" <${process.env.SENDER_EMAIL_ADDRESS}>`,to:"nishalbarman+admin@gmail.com",subject:"RentKaro: New Order Recieved",html:`<html>
                    <body>
                      <div style="width: 100%; padding: 5px 0px; display: flex; justify-content: center; align-items: center; border-bottom: 1px solid rgb(0,0,0,0.3)">
                        <h2>Rent Karo</h2>
                      </div>
                      <div style="padding: 40px; box-shadow: rgba(0, 0, 0, 0.16) 0px 1px 4px;">
                        <center>
                          <span style="font-size: 18px;">Hey Yo Brother you just got a new order, You got a new order. Fullfill the order as soon as possible.
                        </center>
                      </div>
                    </body>
                  </html>`});break;default:console.log(`Unhandled event type ${s.type}`)}return e.send()}catch(t){console.log(t),e.status(500).json({message:t.message})}});Gs.exports=Ks});var B=j((Od,zs)=>{var yn=p("jsonwebtoken");function fn(r){try{if(!r)throw new Error("No token provided");let e=process.env.JWT_SECRET;return{message:"TOKEN_VALIDATED",userDetails:yn.verify(r,e)}}catch(e){if(e.name==="TokenExpiredError"||e.name==="JsonWebTokenError")return{message:"TOKEN_EXPIRED",userDetails:null};throw new Error("Invalid token")}}zs.exports=fn});var R=j((Nd,Ws)=>{var hn=B(),bn=Ct(),In=(...r)=>async(e,t,s)=>{var o,a,n;try{console.log("REQUEST PATH: ",e.path),console.log("REQUEST METHOD: ",e.method);let i=((o=e==null?void 0:e.cookies)==null?void 0:o.token)||((n=(a=e==null?void 0:e.headers)==null?void 0:a.authorization)==null?void 0:n.split(" ")[1]);if(console.log("What are cookies -->",JSON.stringify(e==null?void 0:e.cookies)),console.log("The Token Extracted From Cookies -->",i),!i)return t.clearCookie("token",{httpOnly:!0,secure:!0,sameSite:"none",domain:process.env.NODE_ENV==="production"?".jharna-mehendi.vercel.app":void 0}).status(401).json({message:"No token found on Cookies/Authorization.",redirectTo:"/auth/login"});e.jwt={token:i};let u=hn(i);return u.message==="TOKEN_EXPIRED"?t.clearCookie("token",{httpOnly:!0,secure:!0,sameSite:"none",domain:process.env.NODE_ENV==="production"?".jharna-mehendi.vercel.app":void 0}).status(401).json({message:"Token expired, please login again.",redirectTo:"/auth/login"}):!u||u.message==="TOKEN_INVALID"?t.status(400).json({message:"Token validation failed, JWT validation failed."}):(u=u.userDetails,e.user=u,console.log("User Details",JSON.stringify(u)),console.log("Allowed Roles",r),console.log("User Role",u.roleNumber),r.includes(u.roleNumber)?(e.jwt.role=u==null?void 0:u.roleNumber,e.jwt.center=u==null?void 0:u.center,await bn(),s()):t.status(401).json({message:"Authentication Error: Required role not found."}))}catch(i){return console.error(i),t.status(500).json({message:i.message})}};Ws.exports=In});var Js=j((Ed,Ys)=>{var jn=p("express"),ne=p("mongoose"),Ft=p("jsonwebtoken"),$e=p("bcryptjs"),wn=p("password-validator"),Y=M(),ie=R(),{isValidEmail:Vt,hasOneSpaceBetweenNames:Pn,isValidIndianMobileNumber:Hs}=p("custom-validator-renting"),Rd=B(),Bt=new wn;Bt.is().min(8).has().uppercase().has().lowercase();var Sn=process.env.JWT_SECRET,se=jn.Router();se.patch("/update",ie(0,1,2),async(r,e)=>{var t,s,o;try{let a=[],n=(t=r.body)==null?void 0:t.email,i=(s=r.body)==null?void 0:s.name,u=(o=r.body)==null?void 0:o.password,c={};if(n&&(Vt(n)||a.push("Invalid email"),c.email=n),i&&(Pn(i)||a.push("Full name required"),c.name=i),u){Bt.validate(u)||a.push("Password should be of minimum 8 digits containing uppercase and lowercase characters");let y=$e.genSaltSync(10),f=$e.hashSync(u,y);c.password=f}if(a.length>0)return e.status(400).json({message:a.join(", ")});let l=await Y.findOneAndUpdate({_id:userDetails._id},{$set:c}).populate("role"),m=Ft.sign({_id:l._id,name:l.name,roleName:l.role.roleName,roleNumber:l.role.roleNumber,roleKey:l.role.roleKey,email:l.email,mobileNo:l.mobileNo},Sn);return e.status(200).json({message:"User Updated",user:{name:l.name,email:l.email,mobileNo:l.mobileNo,jwtToken:m}})}catch(a){if(console.log(a),a instanceof ne.Error&&(a!=null&&a.errors)){let n=Object.values(a.errors).map(i=>i.message);return e.status(400).json({status:!1,message:n.join(", ")})}return e.status(500).json({status:!1,message:"Internal server error"})}});se.get("/get-user-chart-data",ie(1,2),async(r,e)=>{var t,s;try{let o=parseInt((t=r.query)==null?void 0:t.year),a=parseInt((s=r.query)==null?void 0:s.month),n=[{$match:{createdAt:{$gte:new Date(o,a-1,1),$lt:new Date(o,a,1)}}},{$group:{_id:{year:{$year:"$createdAt"},month:{$month:"$createdAt"},day:{$dayOfMonth:"$createdAt"}},count:{$sum:1}}},{$project:{_id:0,date:{$dateToString:{format:"%B %d, %Y",date:{$dateFromParts:{year:"$_id.year",month:"$_id.month",day:"$_id.day"}}}},count:1}},{$sort:{date:1}},{$group:{_id:null,totalUsers:{$sum:"$count"},chartData:{$push:"$$ROOT"}}},{$project:{_id:0,totalUsers:1,chartData:1}}],i=await Y.aggregate(n);return e.status(200).json(i[0])}catch(o){if(console.log(o),o instanceof ne.Error&&(o!=null&&o.errors)){let a=Object.values(o.errors).map(n=>n.message);return e.status(400).json({message:a.join(", ")})}return e.status(500).json({message:"Internal server error"})}});se.get("/",ie(1,2),async(r,e)=>{var t,s,o;try{let a=parseInt(r.query.page)||1,n=parseInt(r.query.limit)||10,i=(a-1)*n,u=(t=r.query)==null?void 0:t.userType,c={};u?c["role.roleNumber"]=+u:delete c["role.roleNumber"],console.log("matchQuery",c);let l=[{$lookup:{from:"roles",localField:"role",foreignField:"_id",as:"role"}},{$unwind:"$role"},{$match:c},{$skip:i},{$limit:n},{$sort:{createdAt:-1}},{$project:{password:0,"role._id":0}}],m=await Y.aggregate(l),y=await Y.aggregate([{$lookup:{from:"roles",localField:"role",foreignField:"_id",as:"role"}},{$unwind:"$role"},{$match:c},{$count:"totalUsers"}]),f=Math.ceil((((s=y[0])==null?void 0:s.totalUsers)||0)/n);return e.status(200).json({users:m,pagination:{page:a,limit:n,totalUsers:((o=y[0])==null?void 0:o.totalUsers)||0,totalPages:f}})}catch(a){return console.log(a),e.status(500).json({message:"Internal server error"})}});se.get("/admin/view/:id",ie(1,2),async(r,e)=>{try{let{id:t}=r.params;if(!ne.Types.ObjectId.isValid(t))return e.status(400).json({message:"Invalid user ID"});let s=await Y.findById(t,{password:0}).populate("role");return s?e.status(200).json(s):e.status(404).json({message:"User not found"})}catch(t){return console.log(t),e.status(500).json({message:"Internal server error"})}});se.post("/",ie(1,2),async(r,e)=>{try{let{name:t,email:s,mobileNo:o,password:a,role:n}=r.body;if(!t||!s||!o||!a||!n)return e.status(400).json({message:"All fields are required"});if(!Vt(s))return e.status(400).json({message:"Invalid email address"});if(!Hs(o))return e.status(400).json({message:"Invalid Indian mobile number"});if(await Y.findOne({email:s}))return e.status(400).json({message:"Email already exists"});let u=$e.genSaltSync(10),c=$e.hashSync(a,u),l=new Y({name:t,email:s,mobileNo:o,password:c,role:n,isEmailVerified:!1,isMobileNoVerified:!1});return await l.save(),e.status(201).json({message:"User created successfully",user:{_id:l._id,name:l.name,email:l.email,mobileNo:l.mobileNo,role:l.role,isEmailVerified:l.isEmailVerified,isMobileNoVerified:l.isMobileNoVerified}})}catch(t){if(console.error(t),t instanceof ne.Error.ValidationError){let s=Object.values(t.errors).map(o=>o.message);return e.status(400).json({message:s.join(", ")})}return e.status(500).json({message:"Internal server error"})}});se.patch("/update/:id",ie(1,2),async(r,e)=>{var t;try{let{id:s}=r.params,o=(t=r.body)==null?void 0:t.userData;if(!o)return e.status(400).json({message:"All fields are required"});let{name:a,email:n,mobileNo:i,password:u,role:c}=o;if(!ne.Types.ObjectId.isValid(s))return e.status(400).json({message:"Invalid user ID"});if(!a||!n||!i||!c)return e.status(400).json({message:"All fields are required"});let l=[];if(Vt(n)||l.push("Invalid email address"),Hs(i)||l.push("Invalid Indian mobile number"),ne.Types.ObjectId.isValid(c)||l.push("Invalid role ID"),u&&!Bt.validate(u)&&l.push("Password should be of minimum 8 digits containing uppercase and lowercase characters"),l.length>0)return e.status(400).json({message:l.join(`,
`)});let m=await Y.findById(s);if(!m)return e.status(404).json({message:"User not found"});if(a&&(m.name=a),n&&(m.email=n),i&&(m.mobileNo=i),c&&(m.role=c),u){let y=$e.genSaltSync(10);m.password=$e.hashSync(u,y)}return await m.save({validateBeforeSave:!1}),e.status(200).json({message:"User updated successfully",user:{_id:m._id,name:m.name,email:m.email,mobileNo:m.mobileNo,role:m.role,isEmailVerified:m.isEmailVerified,isMobileNoVerified:m.isMobileNoVerified}})}catch(s){if(console.error(s),s instanceof ne.Error.ValidationError){let o=Object.values(s.errors).map(a=>a.message);return e.status(400).json({message:o.join(", ")})}return e.status(500).json({message:"Internal server error"})}});se.delete("/:id",ie(1,2),async(r,e)=>{try{let{id:t}=r.params;return ne.Types.ObjectId.isValid(t)?await Y.findByIdAndDelete(t)?e.status(200).json({message:"User deleted successfully"}):e.status(404).json({message:"User not found"}):e.status(400).json({message:"Invalid user ID"})}catch(t){return console.log(t),e.status(500).json({message:"Internal server error"})}});se.get("/me",ie(0,1,2),async(r,e)=>{try{let t=r.user._id,s=await Y.findById(t).select("-password -emailVerifyToken -resetToken").populate("role","roleName roleNumber roleKey").populate("defaultAddress").populate("center");return s?e.status(200).json({_id:s._id,name:s.name,email:s.email,mobileNo:s.mobileNo,isEmailVerfied:s.isEmailVerfied,isMobileNoVerified:s.isMobileNoVerified,role:s.role,defaultAddress:s.defaultAddress,center:s.center,createdAt:s.createdAt,updatedAt:s.updatedAt}):e.status(404).json({message:"User not found"})}catch(t){return console.error("Error fetching user profile:",t),t instanceof Ft.JsonWebTokenError?e.status(401).json({message:"Invalid token"}):t instanceof Ft.TokenExpiredError?e.status(401).json({message:"Token expired"}):e.status(500).json({status:!1,message:"Internal server error"})}});Ys.exports=se});var Gt=j((Cd,Qs)=>{var Kt=p("mongoose"),vn=new Kt.Schema({name:{type:String},email:{type:String},mobileNo:{type:String},otp:{type:String,required:!0}},{timestamps:!0}),qn=Kt.models.registration_otp||Kt.model("registration_otp",vn);Qs.exports=qn});var zt=j((xd,Zs)=>{var Lt=p("mongoose"),$n=new Lt.Schema({roleName:{type:String,required:!0},roleNumber:{type:Number,required:!0},roleKey:{type:String}},{timestamps:!0}),Tn=Lt.models.roles||Lt.model("roles",$n);Zs.exports=Tn});var Wt=j((Md,Xs)=>{var An=p("mongoose"),_n=(r,e,t,s)=>{if(console.error(e),e!==void 0&&e instanceof An.Error&&(e!=null&&e.errors)){let o=Object.values(e.errors).map(a=>a.message);return r.status(400).json({message:o.join(", ")})}return r.status(t||500).json({message:s||"Internal server error"})};Xs.exports={globalErrorHandler:_n}});var rr=j((Kd,sr)=>{var Dn=p("express"),er=p("mongoose"),Ht=p("jsonwebtoken"),mt=p("bcryptjs"),kn=p("password-validator"),{v4:On}=p("uuid"),gt=M(),Ud=Gt(),Fd=zt(),{isValidEmail:Yt,isValidIndianMobileNumber:Vd,hasOneSpaceBetweenNames:Bd}=p("custom-validator-renting"),{globalErrorHandler:Nn}=Wt(),tr=new kn;tr.is().min(8).has().uppercase().has().lowercase();var Jt=process.env.JWT_SECRET,Le=Dn.Router();Le.post("/admin-login",async(r,e)=>{var t,s,o;try{let a=[],{email:n,password:i}=r.body;if(Yt(n)||a.push("Invalid email address"),a.length>0)return e.status(400).json({message:a.join(", ")});let u=await gt.findOne({email:n}).populate("role");if(console.log(u?`We got one user with given email: ${u==null?void 0:u.email} and Role: ${(t=u==null?void 0:u.role)==null?void 0:t.roleName}`:"No user found for the given email"),!(u&&(((s=u.role)==null?void 0:s.roleKey)==="admin"||((o=u.role)==null?void 0:o.roleKey)==="super-admin")))return e.status(400).json({message:"The provided credentials are invalid."});let c=mt.compareSync(i,u.password);if(console.log(`Is the provided password valid after comparing with bcrypt: for password: ${i} ---> ${c}`),!c)return e.status(400).json({message:"The provided credentials are invalid."});let l=Ht.sign({_id:u._id,name:u.name,roleName:u.role.roleName,roleNumber:u.role.roleNumber,roleKey:u.role.roleKey,email:u.email,mobileNo:u.mobileNo},Jt);return e.cookie("token",l,{httpOnly:!0,secure:!0,sameSite:"none"}).status(200).json({message:"Login successful",user:{name:u.name,email:u.email,roleName:u.role.roleName,roleNumber:u.role.roleNumber,roleKey:u.role.roleKey,mobileNo:u.mobileNo,jwtToken:l}})}catch(a){Nn(e,a)}});Le.post("/login",async(r,e)=>{try{let t=[],{email:s,mobileNo:o,password:a}=r.body;if(console.log(s,o,a),Yt(s)||t.push("Invalid email address"),t.length>0)return e.status(400).json({status:!1,message:t.join(", ")});let n=await gt.findOne({email:s}).populate("role");if(!n)return e.status(400).json({message:"The provided credentials are invalid."});if(!mt.compareSync(a,n.password))return e.status(400).json({message:"The provided credentials are invalid."});let u=Ht.sign({_id:n._id,name:n.name,roleName:n.role.roleName,roleNumber:n.role.roleNumber,roleKey:n.role.roleKey,email:n.email,mobileNo:n.mobileNo,center:n==null?void 0:n.center},Jt),c=1440*60*1e3;return e.cookie("token",u,{httpOnly:!0,secure:!0,sameSite:"none"}).status(200).json({message:"Login successful",user:{name:n.name,email:n.email,mobileNo:n.mobileNo,jwtToken:u}})}catch(t){if(console.log(t),t instanceof er.Error&&(t!=null&&t.errors)){let s=Object.values(t.errors).map(o=>o.message);return e.status(400).json({message:s.join(", ")})}return e.status(500).json({message:"Internal server error"})}});Le.post("/signup",async(r,e)=>{try{let t=[],{email:s,name:o,mobileNo:a,password:n,otp:i}=r.body;if(Yt(s)||t.push("Invalid email"),tr.validate(n)||t.push("Password should be of minimum 8 digits containing uppercase and lowercase characters"),await gt.findOne({email:s})&&t.push("User already exists with the provided email"),t.length>0)return e.status(400).json({status:!1,message:t.join(", ")});let c=mt.genSaltSync(10),l=mt.hashSync(n,c),m=On(),y=await gt.create({email:s,name:o,mobileNo:a,password:l,mobileNoVerifyToken:m,role:"698f03e9100596fe285eecbf"}),f=Ht.sign({_id:y._id,name:y.name,roleName:"user",roleKey:"user",roleNumber:0,email:y.email,mobileNo:y.mobileNo,center:y==null?void 0:y.center},Jt);return console.log("User Created"),e.status(200).json({status:!0,message:"Registration successful",user:{name:y.name,email:y.email,mobileNo:y.mobileNo,jwtToken:f}})}catch(t){if(console.log(t),t instanceof er.Error&&(t!=null&&t.errors)){let s=Object.values(t.errors).map(o=>o.message);return e.status(400).json({status:!1,message:s.join(", ")})}return e.status(500).json({status:!1,message:"Internal server error"})}});Le.post("/logout",async(r,e)=>e.clearCookie("token",{httpOnly:!0,secure:!0,sameSite:"none"}).status(200).json({message:"Logged out"}));sr.exports=Le});var ar=j((Gd,or)=>{var Rn=p("axios"),En=async({numbers:r,message:e})=>{try{let t="RENT-TXTLCL",s=process.env.FAST2SMS_API_KEY,o=await Rn.post("https://www.fast2sms.com/dev/bulkV2",{authorization:process.env.FAST2SMS_AUTH_KEY,variables_values:e,route:"otp",numbers:r});if(console.log(o.data.messages),o.data.status==="success")console.log("OTP Message sent!");else throw new Error("OTP send failed!")}catch(t){throw t}};or.exports=En});var ur=j((zd,ir)=>{var Cn=p("express"),xn=Gt(),{generateRandomCode:Mn,isValidIndianMobileNumber:Un,hasOneSpaceBetweenNames:Fn,isValidEmail:Vn}=p("custom-validator-renting"),Ld=ar(),nr=Cn.Router();nr.post("/",async(r,e)=>{try{let t=[],{email:s,name:o,mobileNo:a}=r.body;if(console.log({email:s,name:o,mobileNo:a}),Fn(o)||t.push("Full name required"),Vn(s)||t.push("Invalid email"),Un(a)||t.push("Invalid phone number"),t.length>0)return e.status(200).json({status:!1,message:t.join(", ")});let n=Mn();console.log(n);let i=`Your Renting App verification code is: ${n}. Don't share this code with anyone; our employees will never ask for the code.`;await new xn({email:s,name:o,mobileNo:a,otp:n}).save();return e.status(200).json({status:!0,message:"OTP sent to your mobile number"})}catch(t){return console.log(t),e.status(500).json({status:!1,message:t.message})}});ir.exports=nr});var dr=j((Qd,cr)=>{var Qt=p("mongoose"),{hasOneSpaceBetweenNames:Wd,isValidEmail:Hd,isValidIndianMobileNumber:Yd,isValidUrl:Jd}=p("custom-validator-renting"),Bn=new Qt.Schema({imageUrl:{type:String,required:!0},title:{type:String,required:!0},altText:{type:String,required:!0},description:{type:String,required:!0},redirectUrl:{type:String,required:!1,default:null},bgColor:{type:String,required:!0},key:{type:String,required:!0,unique:!0}},{timestamps:!0,query:{all(){return this.where({})}}}),Kn=Qt.models.banners||Qt.model("banners",Bn);cr.exports=Kn});var pr=j((Xd,lr)=>{var Zd=p("mongoose"),Gn=p("express"),Ln=p("get-image-colors"),ge=dr(),Zt=R(),Te=Gn.Router(),ze="";Te.get("/",async(r,e)=>{try{let t=r.query,s=(t==null?void 0:t.page)||1,o=(t==null?void 0:t.limit)||20,a=(s-1)*o,n=await ge.countDocuments({}),i;o===0?i=await ge.find({}).sort({createdAt:"desc"}):i=await ge.find({}).sort({createdAt:"desc"}).skip(a).limit(o);let u=Math.ceil(n/o);return e.status(200).json({totalPages:u,banners:i})}catch(t){return console.log(ze,t),e.status(500).json({message:"Internal Server Error",status:!1})}});Te.post("/",Zt(1,2),async(r,e)=>{var t;try{let s=(t=r.body)==null?void 0:t.categoryData;if(!s)return e.status(400).json({message:"Category Data Not Found"});console.log(s);let o=await Ln(s.imageUrl,{count:5}),[a,n,i,...u]=o[0]._rgb,c=`rgba(${a},${n},${i},0.8)`,l=await ge.create({imageUrl:s.imageUrl,title:s.title,description:s.description,redirectUrl:s.redirectUrl,bgColor:c,altText:s.title.replaceAll(" ","-").toLowerCase(),key:s.title.trim().replaceAll(" ","-").toLowerCase()});return e.status(200).json({message:"Banner created",data:l})}catch(s){return console.error(ze,s),e.status(500).json({message:s.message})}});Te.patch("/update/:categoryId",Zt(1,2),async(r,e)=>{var t,s;try{let o=(t=r.params)==null?void 0:t.categoryId,a=(s=r.body)==null?void 0:s.categoryData;return a?o?(a!=null&&a.categoryName?a.categoryKey=a.categoryName.trim().replaceAll(" ","-").toLowerCase():delete a.categoryName,await ge.updateOne({_id:o},{$set:a}),e.status(200).json({message:"Category updated"})):e.status(400).json({message:"Category Id Not Found"}):e.status(400).json({message:"Category Data Not Found"})}catch(o){return console.error(ze,o),e.status(500).json({message:o.message})}});Te.delete("/:categoryId",Zt(1,2),async(r,e)=>{var t;try{let s=(t=r.params)==null?void 0:t.categoryId;if(!s)return e.status(400).json({message:"Category ID Found"});let o=await ge.deleteOne({_id:s});return e.status(200).json({message:"Category Deleted"})}catch(s){return console.error(ze,s),e.status(500).json({message:s.message})}});Te.get("/view/:categoryId",async(r,e)=>{var t;try{let s=(t=r.params)==null?void 0:t.categoryId;if(!s)return e.status(400).json({message:"Category ID Found"});let o=await ge.findOne({_id:s});return e.status(200).json({banner:o})}catch(s){return console.error(ze,s),e.status(500).json({message:s.message})}});lr.exports=Te});var gr=j((el,mr)=>{var Xt=p("mongoose"),zn=new Xt.Schema({categoryName:{type:String,required:!0},categoryImageUrl:{type:String,required:!0},categoryKey:{type:String,required:!1,unique:!0}},{timestamps:!0}),Wn=Xt.models.categories||Xt.model("categories",zn);mr.exports=Wn});var yt=j((tl,yr)=>{var{FirebaseUtils:Hn}=p("firebase-utils"),{Base64Decode:Yn}=p("base64-stream"),Jn=r=>new Promise((e,t)=>{let s=[];r.on("data",o=>s.push(o)),r.on("end",()=>e(Buffer.concat(s))),r.on("error",t)}),es=class{static async uploadBulkImages(e){let t=e.map(async s=>{let o=new Yn;o.write(s.base64String.replace(/^data:image\/\w+;base64,/,"")),o.end();let a=await Jn(o);return Hn.uploadImage(a,s.type)});return Promise.all(t)}constructor(){}};yr.exports={ImageUploadHelper:es}});var hr=j((ol,fr)=>{var Qn=p("express"),Ae=Qn.Router(),ye=gr(),sl=B(),{ImageUploadHelper:rl}=yt(),ts=R(),We="categories.routes.js:--";Ae.get("/",async(r,e)=>{try{let t=r.query,s=(t==null?void 0:t.page)||1,o=(t==null?void 0:t.limit)||20,a=(s-1)*o,n=await ye.countDocuments({}),i;o===0?i=await ye.find({}).sort({createdAt:"desc"}):i=await ye.find({}).sort({createdAt:"desc"}).skip(a).limit(o);let u=Math.ceil(n/o);return e.status(200).json({totalPages:u,categories:i})}catch(t){return console.log(We,t),e.status(500).json({message:"Internal Server Error",status:!1})}});Ae.post("/",ts(1,2),async(r,e)=>{var t;try{let s=(t=r.body)==null?void 0:t.categoryData;if(!s)return e.status(400).json({message:"Category Data Not Found"});console.log(s);let o=await ye.create({categoryImageUrl:s.categoryImageUrl,categoryName:s.categoryName,categoryKey:s.categoryName.trim().replaceAll(" ","-").toLowerCase()});return e.status(200).json({message:"Category created",data:o})}catch(s){return console.error(We,s),e.status(500).json({message:s.message})}});Ae.patch("/update/:categoryId",ts(1,2),async(r,e)=>{var t,s;try{let o=(t=r.params)==null?void 0:t.categoryId,a=(s=r.body)==null?void 0:s.categoryData;return a?o?(a!=null&&a.categoryName?a.categoryKey=a.categoryName.trim().replaceAll(" ","-").toLowerCase():delete a.categoryName,await ye.updateOne({_id:o},{$set:a}),e.status(200).json({message:"Category updated"})):e.status(400).json({message:"Category Id Not Found"}):e.status(400).json({message:"Category Data Not Found"})}catch(o){return console.error(We,o),e.status(500).json({message:o.message})}});Ae.delete("/:categoryId",ts(1,2),async(r,e)=>{var t;try{let s=(t=r.params)==null?void 0:t.categoryId;if(!s)return e.status(400).json({message:"Category ID Found"});let o=await ye.deleteOne({_id:s});return e.status(200).json({message:"Category Deleted"})}catch(s){return console.error(We,s),e.status(500).json({message:s.message})}});Ae.get("/view/:categoryId",async(r,e)=>{var t;try{let s=(t=r.params)==null?void 0:t.categoryId;if(!s)return e.status(400).json({message:"Category ID Found"});let o=await ye.findOne({_id:s});return e.status(200).json({category:o})}catch(s){return console.error(We,s),e.status(500).json({message:s.message})}});fr.exports=Ae});var Ir=j((al,br)=>{var ss=p("mongoose"),Zn=new ss.Schema({featureName:{type:String,required:!0},featureDescription:{type:String,required:!0},featureImageUrl:{type:String,required:!0},featureKey:{type:String,required:!1,unique:!0}},{timestamps:!0}),Xn=ss.models.features||ss.model("features",Zn);br.exports=Xn});var wr=j((nl,jr)=>{var ei=p("express"),_e=ei.Router(),fe=Ir(),rs=R(),He="features.routes.js:--";_e.get("/",async(r,e)=>{try{let t=r.query,s=(t==null?void 0:t.page)||1,o=(t==null?void 0:t.limit)||20,a=(s-1)*o,n=await fe.countDocuments({}),i;o===0?i=await fe.find({}).sort({createdAt:"desc"}):i=await fe.find({}).sort({createdAt:"desc"}).skip(a).limit(o);let u=Math.ceil(n/o);return e.status(200).json({totalPages:u,features:i})}catch(t){return console.log(He,t),e.status(500).json({message:"Internal Server Error",status:!1})}});_e.post("/",rs(1,2),async(r,e)=>{var t;try{let s=(t=r.body)==null?void 0:t.featureData;if(!s)return e.status(400).json({message:"Feature Data Not Found"});console.log(s);let o=await fe.create({featureImageUrl:s.featureImageUrl,featureName:s.featureName,featureKey:s.featureName.trim().replaceAll(" ","-").toLowerCase()});return e.status(200).json({message:"Feature created",data:o})}catch(s){return console.error(He,s),e.status(500).json({message:s.message})}});_e.patch("/update/:featureId",rs(1,2),async(r,e)=>{var t,s;try{let o=(t=r.params)==null?void 0:t.featureId,a=(s=r.body)==null?void 0:s.featureData;return a?o?(a!=null&&a.featureName?a.featureKey=a.featureName.trim().replaceAll(" ","-").toLowerCase():delete a.featureName,await fe.updateOne({_id:o},{$set:a}),e.status(200).json({message:"Feature updated"})):e.status(400).json({message:"Feature Id Not Found"}):e.status(400).json({message:"Feature Data Not Found"})}catch(o){return console.error(He,o),e.status(500).json({message:o.message})}});_e.delete("/:featureId",rs(1,2),async(r,e)=>{var t;try{let s=(t=r.params)==null?void 0:t.featureId;if(!s)return e.status(400).json({message:"Feature ID Found"});let o=await fe.deleteOne({_id:s});return e.status(200).json({message:"Feature Deleted"})}catch(s){return console.error(He,s),e.status(500).json({message:s.message})}});_e.get("/view/:featureId",async(r,e)=>{var t;try{let s=(t=r.params)==null?void 0:t.featureId;if(!s)return e.status(400).json({message:"Feature ID Found"});let o=await fe.findOne({_id:s});return e.status(200).json({feature:o})}catch(s){return console.error(He,s),e.status(500).json({message:s.message})}});jr.exports=_e});var os=j((il,Pr)=>{var Ye=p("mongoose"),ti=new Ye.Schema({user:{type:Ye.Types.ObjectId,ref:"users"},product:{type:Ye.Types.ObjectId,ref:"products"},productType:{type:String,enums:["rent","buy"]}},{timestamps:!0}),si=Ye.models.wishlist||Ye.model("wishlist",ti);Pr.exports=si});var qr=j((dl,vr)=>{var ri=p("express"),J=ri.Router(),as=p("mongoose"),Sr=p("cheerio"),{Product:K,ProductVariant:De}=te(),oi=os(),ai=B(),{isValidUrl:ul}=p("custom-validator-renting"),ni=x(),Je=R(),{ImageUploadHelper:cl}=yt(),ii=L(),ke="products/route.js:--",ui=({previewImage:r,title:e,category:t,discountedPrice:s,originalPrice:o,slideImages:a,description:n,shippingPrice:i,availableStocks:u,isVariantAvailable:c,productVariant:l,rentingPrice:m})=>{let y=[],f=/^https:\/\/i\.ibb\.co\//;if(f.test(r)||y.push("Preview Image does not have valid allowed url"),!Array.isArray(a)){let d=!0;for(let S=0;S<a.length;S++)if(d=d&&f.test(a[S]),!d){y.push("Slide Images does not have valid allowed url");break}}(!e||(e==null?void 0:e.length)<5)&&y.push("Title should be of minimum 5 characters");let w=as.Types.ObjectId;(!t||!(w.isValid(t)&&String(new w(t))===t))&&y.push("Category is not valid"),!s&&!m&&y.push("Discounted price and Renting Price needs to be given"),(isNaN(Number(m))||isNaN(Number(s))||isNaN(Number(o)))&&y.push("Original price, Discounted price and Renting price should be numbers"),s&&o&&+o<+s&&y.push("Discounted price should be lesser than Original price if given");try{let d=Sr.load(n)}catch (e2){y.push("Description is not valid html")}return i&&isNaN(parseInt(i))&&y.push("Shipping price must be a valid number"),u&&isNaN(parseInt(u))&&y.push("Stock mube be a valid non zero number"),c&&l.forEach((d,S)=>{if(Object.keys(d).length!==9)return y.push("Variant +"+(S+1)+": Does not contain all the required keys");let P=[];if(f.test(d==null?void 0:d.previewImage)||P.push("Variant +"+(S+1)+": Preview Image is not valid"),!(d!=null&&d.discountedPrice)&&!(d!=null&&d.originalPrice)&&P.push("Original price and Discounted price needs to be given"),(isNaN(Number(m))||isNaN(Number(s))||isNaN(Number(o)))&&y.push("Original price, Discounted price and Renting price should be numbers"),d!=null&&d.discountedPrice&&(d!=null&&d.originalPrice)&&+(d==null?void 0:d.originalPrice)<+(d==null?void 0:d.discountedPrice)&&P.push("Discounted price should be lesser than original price"),!Array.isArray(d==null?void 0:d.slideImages)){let b=!0;for(let v=0;v<(d==null?void 0:d.slideImages.length);v++)if(b=b&&f.test(d==null?void 0:d.slideImages[v]),!b){P.push("Slide Images does not have valid allowed url");break}}d!=null&&d.shippingPrice&&isNaN(parseInt(d==null?void 0:d.shippingPrice))&&P.push("Shipping price must be a valid number"),d!=null&&d.availableStocks&&isNaN(parseInt(d==null?void 0:d.availableStocks))&&P.push("Stock mube be a valid non zero number"),d!=null&&d.color||P.push("Color is not vallid"),d!=null&&d.size||P.push("Size is not vallid"),P.length>0&&y.push(`Variant: ${S+1}, has errors. Message: ${P.join(`,
`)}`)}),y},ci=({previewImage:r,title:e,category:t,discountedPrice:s,originalPrice:o,slideImages:a,description:n,shippingPrice:i,availableStocks:u,isVariantAvailable:c,productVariant:l,rentingPrice:m})=>{let y=[],f=/^https:\/\/i\.ibb\.co\//;if(f.test(r)||y.push("Preview Image does not have valid allowed url"),!Array.isArray(a)){let d=!0;for(let S=0;S<a.length;S++)if(d=d&&f.test(a[S]),!d){y.push("Slide Images does not have valid allowed url");break}}(!e||(e==null?void 0:e.length)<5)&&y.push("Title should be of minimum 5 characters");let w=as.Types.ObjectId;(!t||!(w.isValid(t)&&String(new w(t))===t))&&(!(t!=null&&t._id)||!(w.isValid(t==null?void 0:t._id)&&String(new w(t==null?void 0:t._id))===(t==null?void 0:t._id)))&&y.push("Category is not valid"),!s&&!m&&y.push("Discounted price and Renting Price needs to be given"),(isNaN(Number(m))||isNaN(Number(s))||isNaN(Number(o)))&&y.push("Original price, Discounted price and Renting price should be numbers"),s&&o&&+o<+s&&y.push("Discounted price should be lesser than Original price if given");try{let d=Sr.load(n)}catch (e3){y.push("Description is not valid html")}return i&&isNaN(parseInt(i))&&y.push("Shipping price must be a valid number"),u&&isNaN(parseInt(u))&&y.push("Stock mube be a valid non zero number"),c&&(console.log("What is product Variants",l),Object.values(l).forEach((d,S)=>{var b;if(((b=Object.keys(d))==null?void 0:b.length)<8)return y.push("Variant +"+(S+1)+": Does not contain all the required keys");let P=[];if(f.test(d==null?void 0:d.previewImage)||P.push("Variant +"+(S+1)+": Preview Image is not valid"),!(d!=null&&d.discountedPrice)&&!(d!=null&&d.originalPrice)&&P.push("Original price and Discounted price needs to be given"),(isNaN(Number(m))||isNaN(Number(s))||isNaN(Number(o)))&&y.push("Original price, Discounted price and Renting price should be numbers"),d!=null&&d.discountedPrice&&(d!=null&&d.originalPrice)&&+(d==null?void 0:d.originalPrice)<+(d==null?void 0:d.discountedPrice)&&P.push("Discounted price should be lesser than original price"),!Array.isArray(d==null?void 0:d.slideImages)){let v=!0;for(let D=0;D<(d==null?void 0:d.slideImages.length);D++)if(v=v&&f.test(d==null?void 0:d.slideImages[D]),!v){P.push("Slide Images does not have valid allowed url");break}}d!=null&&d.shippingPrice&&isNaN(parseInt(d==null?void 0:d.shippingPrice))&&P.push("Shipping price must be a valid number"),d!=null&&d.availableStocks&&isNaN(parseInt(d==null?void 0:d.availableStocks))&&P.push("Stock mube be a valid non zero number"),d!=null&&d.color||P.push("Color is not vallid"),d!=null&&d.size||P.push("Size is not vallid"),P.length>0&&y.push(`Variant: ${S+1}, has errors. Message: ${P.join(`,
`)}`)})),y};J.get("/",async(r,e)=>{try{let t=r.query,s=parseInt(t==null?void 0:t.page)||0,o=parseInt(t==null?void 0:t.limit)||50,a=s*o,n=t.sort||"popularity",i=t.query,u={};if(i&&(u.$text={$search:i}),t.category){let d=t.category.split(",");u.category={$in:d.map(S=>new as.Types.ObjectId(S))}}let c=parseFloat(t.minPrice)||0,l=parseFloat(t.maxPrice)||200;(c>0||l<200)&&(u.discountedPrice={$gte:c,$lte:l});let m={createdAt:"desc"};if(i&&!n&&(delete m.createdAt,m.score={$meta:"textScore"}),n)switch(delete m.createdAt,n){case"popularity":m.totalOrders="desc";break;case"low-to-hight-price":m.discountedPrice="asc";break;case"hight-to-low-price":m.discountedPrice="desc";break;case"newest":m.createdAt="desc";break;default:m=void 0}let y=await K.countDocuments(u),f=await K.find(u).populate(["category","productVariant"]).sort(m).skip(a).limit(o),w=Math.ceil(y/o);return e.status(200).json({totalPages:w,data:f,totalProductCount:y})}catch(t){return console.error("Error in product route:",t),e.status(500).json({message:t.message,stack:process.env.NODE_ENV==="development"?t.stack:void 0})}});J.post("/view/:productId",async(r,e)=>{var t,s,o,a;try{let n=r.params,i=((t=r.body)==null?void 0:t.productType)||"buy",u=(s=r.headers.authorization)==null?void 0:s.split(" ")[1],c=null;if(u&&(c=ai(u)),console.log("What are params",n),!(n!=null&&n.productId))return e.status(400).json({redirect:"/products",message:"Product ID missing!"});let l=await K.findOne({_id:n==null?void 0:n.productId}).populate(["category","productVariant"]);console.log("What is the product",n==null?void 0:n.productId,l);let m=!1;return c&&c.userDetails&&c.userDetails._id&&(m=await ni.countDocuments({product:n.productId,user:(o=c==null?void 0:c.userDetails)==null?void 0:o._id,orderType:i,orderStatus:"Delivered"}),console.log("has user bought",{product:n.productId,user:((a=c==null?void 0:c.userDetails)==null?void 0:a._id)||void 0,orderType:i,orderStatus:"Delivered"})),l?e.status(200).json({product:l,hasUserBoughtThisProduct:!!m}):e.status(404).json({message:"No such product found."})}catch(n){return console.error(ke,n),e.status(500).json({message:n.message})}});J.get("/admin-view/:productId",Je(1,2),async(r,e)=>{var t;try{let s=(t=r.params)==null?void 0:t.productId;if(!s)return e.status(400).json({redirect:"/products",message:"Product ID missing!"});let o=await K.findOne({_id:s}).populate(["category","productVariant"]);return o?e.status(200).json({product:o}):e.status(404).json({message:"No such product found."})}catch(s){return console.error(ke,s),e.status(500).json({message:s.message})}});J.post("/",Je(1,2),async(r,e)=>{var t;try{let s=(t=r.body)==null?void 0:t.productData;if(!s)return e.status(400).json({message:"Product Data Not Found"});if(s.originalPrice||(s.originalPrice=s.discountedPrice),s.productVariant=Object.values(s.productVariant),Array.isArray(s==null?void 0:s.productVariant)){let n=[];s.productVariant.forEach(i=>{var c;i.originalPrice||(i.originalPrice=i.discountedPrice);let u=i==null?void 0:i.size;u&&((c=u.split(","))==null||c.forEach(l=>{n.push({...i,size:l})}))}),s.productVariant=n}let o=ui(s);if(o.length>0)return e.status(400).json({message:o.join(", ")});console.log(s);let a=new K({previewImage:s.previewImage,title:s.title,category:s.category,slideImages:s.slideImages,description:s.description,productType:"buy",shippingPrice:+s.shippingPrice,availableStocks:+s.availableStocks,rentingPrice:s.variant?+s.variant[0].rentingPrice:+s.rentingPrice,discountedPrice:s.variant?+s.variant[0].discountedPrice:+s.discountedPrice,originalPrice:s.variant?+s.variant[0].originalPrice:+s.originalPrice,isVariantAvailable:!!s.isVariantAvailable});if(s!=null&&s.isVariantAvailable){let n=Object.entries(s.productVariant).map(async([u,c])=>{let l={product:a._id,previewImage:c.previewImage,slideImages:c.slideImages,size:c.size,color:c.color,availableStocks:+c.availableStocks,shippingPrice:+c.shippingPrice,rentingPrice:+c.rentingPrice,discountedPrice:+c.discountedPrice,originalPrice:+c.originalPrice};return De.create(l)}),i=await Promise.all(n);a.productVariant=i.map(u=>u._id)}return console.log(a),await a.save(),e.status(200).json({message:"Product created",data:s})}catch(s){return console.error(ke,s),e.status(500).json({message:s.message})}});J.patch("/update/:productId",Je(1,2),async(r,e)=>{var t,s,o;try{let a=(t=r.params)==null?void 0:t.productId,n=(s=r.body)==null?void 0:s.productData;if(!a)return e.status(400).json({message:"Product ID Not Found"});if(!n)return e.status(400).json({message:"Product Data Not Found"});console.log("What is product variant, I guess it would be the ids of variant thats why product checkupdate is failed because it does not have the keys (it only has variant ids))",n.productVariant);let i=ci(n);if(i.length>0)return e.status(400).json({message:i.join(", ")});let u={title:n.title,category:n.category,description:n.description,productType:n.productType,shippingPrice:+n.shippingPrice,availableStocks:+n.availableStocks,rentingPrice:+n.rentingPrice,discountedPrice:+n.discountedPrice,originalPrice:+n.originalPrice,isVariantAvailable:!!n.isVariantAvailable};if(n.previewImage&&(u.previewImage=n.previewImage),n.slideImages.length>0&&(u.slideImages=n.slideImages),n!=null&&n.isVariantAvailable){let c=[],l=[],m=[];(o=Object.values(n.productVariant))==null||o.forEach(f=>{f!=null&&f._id?(c.push(f),m.push(f._id)):l.push({product:a,size:f.size,color:f.color,previewImage:f.previewImage,slideImages:f.slideImages,availableStocks:+f.availableStocks,shippingPrice:+f.shippingPrice||0,rentingPrice:+f.rentingPrice||0,discountedPrice:+f.discountedPrice,originalPrice:+f.originalPrice})});let y=c.map(async f=>{let w={size:f.size,color:f.color,availableStocks:+f.availableStocks,shippingPrice:+f.shippingPrice||0,rentingPrice:+f.rentingPrice||0,discountedPrice:+f.discountedPrice,originalPrice:+f.originalPrice};return f.previewImage&&(w.previewImage=f.previewImage),f.slideImages.length&&(w.slideImages=f.slideImages),De.findByIdAndUpdate(f._id,w)});if(await Promise.all(y),l.length>0){let f=l.map(async d=>De.create(d));(await Promise.all(f)).forEach(d=>{m.push(d._id)})}return u.productVariant=m||[],await K.findByIdAndUpdate(a,u),e.status(200).json({message:"Product Updated"})}return await K.findByIdAndUpdate(a,u),e.status(200).json({message:"Product Updated"})}catch(a){return console.error(ke,a),e.status(500).json({message:a.message})}});J.post("/duplicate",Je(1,2),async(r,e)=>{try{let t=r.body.productId,s=await K.findOne({_id:t}),o=new K({previewImage:s.previewImage,title:s.title,category:s.category,slideImages:s.slideImages,description:s.description,productType:"buy",shippingPrice:+s.shippingPrice,availableStocks:+s.availableStocks,rentingPrice:s.variant?+s.variant[0].rentingPrice:+s.rentingPrice,discountedPrice:s.variant?+s.variant[0].discountedPrice:+s.discountedPrice,originalPrice:s.variant?+s.variant[0].originalPrice:+s.originalPrice,isVariantAvailable:!!s.isVariantAvailable});return await o.save(),console.log(o),e.status(200).json({message:"Duplicate product created"})}catch(t){return console.error(ke,t),e.status(500).json({message:t.message})}});J.post("/variant/instock/:productId",async(r,e)=>{var t,s,o;try{console.log("Hit on varian in stockk");let a=(t=r.params)==null?void 0:t.productId,n=((s=r.body)==null?void 0:s.productType)||"buy",i=(o=r.body)==null?void 0:o.variant;console.log("Here what is request body",r.body),console.log("Items",{productId:a,variant:i,productType:n});let u=!1;if(i){let m=await De.findOne({_id:i});return console.log("Variant Data",m),u=!!m&&(m==null?void 0:m.availableStocks)>0,e.json({inStock:u})}let c={_id:a,productType:n},l=await K.findOne(c);return u=!!l&&(l==null?void 0:l.availableStocks)>0,console.log("in stock response",u),e.json({inStock:u})}catch(a){return console.error(a),e.json({status:!1,message:"Internal server error!"})}});J.post("/view-variant/:productVariantId",async(r,e)=>{var t,s;try{let o=(t=r.params)==null?void 0:t.productVariantId,a=((s=r.body)==null?void 0:s.productType)||"buy";if(console.log(r.body),!o)return e.status(400).json({status:!1,message:"Bad request"});let n=await De.findOne({_id:o}).populate({path:"product"});return console.log("Variant Data",n),e.json({variant:n})}catch(o){return console.error(o),e.json({status:!1,message:"Internal server error!"})}});J.post("/delete",Je(1,2),async(r,e)=>{var t;try{let s=(t=r.body)==null?void 0:t.deletableProductIds;if(!Array.isArray(s))return e.status(400).json({message:"Product ID(s) Not Found"});let o=s.map(async a=>{var i;let n=await K.findById(a);console.log(n),await De.deleteMany({_id:{$in:(i=n==null?void 0:n.productVariant)==null?void 0:i.map(u=>u._id)}}),await ii.deleteMany({product:n._id}),await oi.deleteMany({product:n._id}),await K.findByIdAndDelete(a)});return await Promise.all(o),e.json({message:"Product(s) deleted."})}catch(s){return console.error(ke,s),e.status(500).json({message:s.message})}});vr.exports=J});var Tr=j((ll,$r)=>{var ft=p("mongoose"),di=new ft.Schema({title:{type:String,required:!0},shortDescription:{type:String,required:!0},imageUrl:{type:String,required:!0},productId:{type:ft.Schema.Types.ObjectId,ref:"products",required:!0}},{timestamps:!0}),li=ft.models.new_arrival||ft.model("new_arrival",di);$r.exports=li});var _r=j((pl,Ar)=>{var pi=p("express"),Qe=Tr(),Ze=pi.Router();Ze.post("/",async(r,e)=>{try{let{title:t,shortDescription:s,imageUrl:o,productId:a}=r.body,n=new Qe({title:t,shortDescription:s,imageUrl:o,productId:a});await n.save(),e.status(201).json(n)}catch(t){e.status(500).json({message:t.message})}});Ze.get("/",async(r,e)=>{try{let{page:t=1,limit:s=10}=r.query,o=await Qe.find().limit(s*1).skip((t-1)*s).exec(),a=await Qe.countDocuments();e.status(200).json({newArrivals:o,totalPages:Math.ceil(a/s),currentPage:t})}catch(t){e.status(500).json({message:t.message})}});Ze.patch("/:id",async(r,e)=>{try{let{id:t}=r.params,s=await Qe.findByIdAndUpdate(t,r.body,{new:!1});e.status(200).json(s)}catch(t){e.status(500).json({message:t.message})}});Ze.delete("/:id",async(r,e)=>{try{let{id:t}=r.params;await Qe.findByIdAndDelete(t),e.status(200).json({message:"New Arrival deleted successfully"})}catch(t){e.status(500).json({message:t.message})}});Ar.exports=Ze});var kr=j((gl,Dr)=>{var mi=p("express"),ht=mi.Router(),Xe=os(),ml=B(),ns=R();ht.get("/",ns(0,1,2),async(r,e)=>{try{let t=r.headers.producttype||"buy";console.log("Product Type -->",t);let s=r.query,o=s.page||1,a=s.limit||20,n=(o-1)*a,i=r.user,u=await Xe.find({user:i._id,productType:t}).sort({createdAt:"desc"}).skip(n).limit(a).populate("product").select("-user");return console.log("Wishlist data -->",u),e.json({data:u})}catch(t){return console.log(t),e.status(500).json({message:"Internal server error!"})}});ht.post("/",ns(0,1,2),async(r,e)=>{try{let t=r.user;if(!t)return e.status(400).json({message:"User Details Not Found"});let s=r.headers.producttype,{productId:o}=r.body;return console.log("Wishlist Product ID-->",o),o?await Xe.countDocuments({user:t._id,productType:s})>=45?e.status(400).json({message:"Only maximum 50 wishlist items allowed!"}):await Xe.findOne({product:o,user:t._id,productType:s})?e.status(200).json({status:!0,message:"Already in wishlist"}):(await new Xe({user:t._id,product:o,productType:s}).save(),e.json({status:!0,message:"Added to Wishlist"})):e.status(400).json({message:"Product ID is not given on request"})}catch(t){return console.log(t),e.json({status:!1,message:"Internal server error!"},{status:500})}});ht.delete("/:wishlistId",ns(0,1,2),async(r,e)=>{var t;try{let s=(t=r.params)==null?void 0:t.wishlistId;return await Xe.findOneAndDelete({_id:s,user:r.user._id})?e.json({message:"Removed from Wishlist"}):e.status(200).json({message:"Wishlist not found, maybe already deleted."})}catch(s){return console.log(s),e.status(500).json({message:"Internal server error!"})}});Dr.exports=ht});var Oe=j((yl,Or)=>{var is=p("mongoose"),gi=new is.Schema({brandName:{type:String,required:!0,trim:!0},brandEmail:{type:String,required:!0,trim:!0},address:{type:String,required:!0,trim:!0},whatsAppLink:{type:String,trim:!0},facebookLink:{type:String,trim:!0},instagramLink:{type:String,trim:!0},websiteUrl:{type:String,required:!0,trim:!0},newsletterDiscount:{type:Number,default:5},deliveryPrice:{type:Number,default:45},freeDeliveryAbove:{type:Number,default:0},about:{type:String,required:!0,default:""},createdAt:{type:Date,default:Date.now},updatedAt:{type:Date,default:Date.now}}),yi=is.models.web_config||is.model("web_config",gi);Or.exports=yi});var Er=j((hl,Rr)=>{var fi=p("express"),re=fi.Router(),z=L(),fl=B(),{Product:Nr}=te(),hi=Oe(),ue=R();re.get("/",ue(0,1,2),async(r,e)=>{try{let t=r.user;if(!t)return e.status(400).json({message:"User Details Not Found"});let s=r.query,o=+s.page||1,a=+s.limit||20,n=(o-1)*a;n<0&&(n=0);let i=await z.countDocuments({}),u=Math.ceil(i/a),c=await z.find({user:t._id,productType:s.productType||"buy"}).sort({createdAt:"desc"}).skip(n).limit(a).populate([{path:"product",select:"-slideImages -description -stars -productVariant"},{path:"variant"}]).select("-user"),l=await hi.findOne().sort({createdAt:-1}).select("deliveryPrice freeDeliveryAbove");l||(l={deliveryPrice:100,freeDeliveryAbove:0});let m=(l==null?void 0:l.freeDeliveryAbove)>0,y=l==null?void 0:l.freeDeliveryAbove;return console.log(l),e.json({totalCount:i,totalPages:u,cart:c,shippingPrice:l==null?void 0:l.deliveryPrice,requiredMinimumAmountForFreeDelivery:y,isFreeDeliveryMinAmntAvailable:m})}catch(t){return console.log(t),e.json({message:"Internal server error!"})}});re.post("/",ue(0,1,2),async(r,e)=>{var t;try{let s=r.user;if(!s)return e.status(400).json({message:"User Details Not Found"});let o=r.body;if(await z.countDocuments({product:o.productId,user:s._id,productType:o.productType})>=45)return e.status(400).json({message:"Only maximum 50 Cart items allowed!"});let n=await Nr.findById(o.productId);if(n!=null&&n.isVariantAvailable&&!(o!=null&&o.variant)&&(o.variant=(t=n==null?void 0:n.productVariant[0])==null?void 0:t._id),!n)return e.status(400).json({message:"Product ID Invalid!"});let i={product:o.productId,user:s._id,productType:o.productType};if(o!=null&&o.variant&&(i.variant=o.variant),await z.findOneAndUpdate(i,{$inc:{quantity:(o==null?void 0:o.quantity)||1}}))return e.json({status:!0,message:"Added to Cart"});let c=new z({user:s._id,product:o.productId,productType:o.productType,quantity:o.quantity,rentDays:o.rentDays});return o!=null&&o.variant&&(c.variant=o.variant),await c.save(),e.json({message:"Added to Cart"})}catch(s){return console.log(s),e.json({status:!1,message:"Internal server error!"})}});re.patch("/:productType",ue(0,1,2),async(r,e)=>{var t,s,o,a;try{let n=r.user;if(!n)return e.status(400).json({message:"User Details Not Found"});let i=((t=r.params)==null?void 0:t.productType)||"buy";if(!i)return e.status(400).json({message:"Product Type is Missing"});let u=(s=r.query)==null?void 0:s.cart;if(!u)return e.status(400).send({message:"Cart Item Id Missing"});let c=(o=r.body)==null?void 0:o.rentDays,l=(a=r.body)==null?void 0:a.quantity,m=await z.findOne({_id:u,user:n._id,productType:i});return m?(i==="rent"&&c&&(m.rentDays=c),l&&(m.quantity=l),await m.save({validateBeforeSave:!1}),e.json({message:"Cart Updated"})):e.status(400).json({message:"No items in cart"})}catch(n){return console.log(n),e.status(500).json({message:n.message})}});re.patch("/update-qty/:productType",ue(0,1,2),async(r,e)=>{var t,s,o;try{let a=r.user;if(!a)return e.status(400).json({message:"User Details Not Found"});let n=((t=r.params)==null?void 0:t.productType)||"buy";if(!n)return e.status(400).json({message:"Product Type is Missing"});let i=(s=r.query)==null?void 0:s.cartId,u=(o=r.body)==null?void 0:o.quantity,c=await z.findOne({_id:i,user:a._id,productType:n});return c?(u&&(c.quantity=u),await c.save({validateBeforeSave:!1}),e.json({message:"Cart Updated"})):e.status(400).json({message:"No items in cart"})}catch(a){return console.log(a),e.status(500).json({message:a.message})}});re.patch("/update-variant/:cartItemId",ue(0,1,2),async(r,e)=>{try{let t=r.user;if(!t)return e.status(400).json({message:"User Details Not Found"});let{cartItemId:s}=r.params,{variantId:o,productId:a}=r.body;if(!o||!a)return e.status(400).json({message:"Variant ID and Product ID are required"});let n=await Nr.findById(a);if(!n)return e.status(404).json({message:"Product not found"});if(n.isVariantAvailable&&!n.productVariant.some(c=>c._id.equals(o)))return e.status(400).json({message:"Invalid variant for this product"});let i=await z.findOneAndUpdate({_id:s,user:t._id},{variant:o},{new:!0}).populate([{path:"product",select:"-slideImages -description -stars -productVariant"},{path:"variant"}]);return i?e.json({message:"Variant updated successfully",cartItem:i}):e.status(404).json({message:"Cart item not found"})}catch(t){return console.log(t),e.status(500).json({message:"Internal server error"})}});re.delete("/one/:cartItemId",ue(0,1,2),async(r,e)=>{try{let t=r.user;if(!t)return e.status(400).json({message:"User Details Not Found"});let{cartItemId:s}=r.params;return await z.findOneAndDelete({_id:s,user:t._id})?e.json({status:!0,message:"Cart item deleted"}):e.status(200).json({status:!1,message:"No items found!"})}catch(t){return console.log(t),e.status(500).json({status:!1,message:"Internal server error!"})}});re.post("/incart/:productId",ue(0,1,2),async(r,e)=>{try{let t=r.user;if(!t)return e.status(400).json({message:"User Details Not Found"});let s=r.params,o=r.body,a={product:s.productId,productType:o.productType,user:t._id};return o!=null&&o.variant&&(a.variant=o.variant||null),await z.findOne(a)?e.json({incart:!0}):e.json({incart:!1})}catch(t){return console.log(t),e.json({status:!1,message:"Internal server error!"})}});re.delete("/make-cart-empty",ue(0,1,2),async(r,e)=>{try{let t=r.user,s=await z.deleteMany({user:t._id});return e.json({message:"Cart items deleted"})}catch(t){return console.log(t),e.status(500).json({status:!1,message:"Internal server error!"})}});Rr.exports=re});var et=j((bl,Cr)=>{var bt=p("mongoose"),bi=new bt.Schema({fullName:{type:String,required:!0},phone:{type:String,required:!0},user:{type:bt.Types.ObjectId,ref:"users",required:!1},landmark:{type:String,required:!1},postalCode:{type:String,required:!0},country:{type:String,required:!0},streetName:{type:String,required:!0},city:{type:String,required:!0},state:{type:String,required:!0}},{timestamps:!0}),Ii=bt.models.userAddresses||bt.model("user_addresses",bi);Cr.exports=Ii});var Fr=j((Il,Ur)=>{var ji=p("express"),he=ji.Router(),Ne=et(),xr=M(),Mr=p("mongoose"),Re=R();he.get("/",Re(0,1,2),async(r,e)=>{try{let t=r.user;if(!t)return e.status(400).json({status:!1,message:"Token validation failed"});let s=await Ne.find({user:t._id}).sort({createdAt:"desc"}).select("-user");return e.json({data:s})}catch(t){return console.log(t),e.status(500).json({message:"Internal server error!"})}});he.post("/",Re(0,1,2),async(r,e)=>{try{let t=r.user;return await Ne.countDocuments({user:t._id})>=5?e.status(400).json({status:!1,message:"UserAddress limit reached, you can only add upto 5 addresses"}):(await new Ne({user:t._id,...r.body}).save(),e.json({message:"Address added."}))}catch(t){if(console.log(t),t instanceof Mr.Error){let s=[];for(let o in t.errors)s.push(t.errors[o].properties.message);return e.status(400).json({message:s.join(", ").replaceAll(" Path","")})}return e.status(500).json({message:"Internal server error"})}});he.get("/get-default-address",Re(0,1,2),async(r,e)=>{try{let t=r.user,s=await xr.findOneById(t._id).sort({createdAt:"desc"}).select("defaultAddress");return e.json({defaultAddress:s==null?void 0:s.defaultAddress})}catch(t){return console.log(t),e.status(500).json({message:"Internal server error!"})}});he.post("/update-default-address",Re(0,1,2),async(r,e)=>{try{let t=r.body,s=r.user;if(t.addressId)return e.status(400).json({message:"Invalid request"});let o=await Ne.finedOne(t.addressId);if(!o)return e.status(400).json({message:"Invalid Adress Id"});let a=await xr.findByIdAndUpdate(s._id,{$set:{defaultAddress:o._id}});return e.json({message:"Default Address Updated."})}catch(t){if(console.log(t),t instanceof Mr.Error){let s=[];for(let o in t.errors)s.push(t.errors[o].properties.message);return e.status(400).json({message:s.join(", ").replaceAll(" Path","")})}return e.status(500).json({message:"Internal server error"})}});he.patch("/:address_item_id",Re(0,1,2),async(r,e)=>{try{let t=r.user,{address_item_id:s}=r.params;if(!(r!=null&&r.body))return e.status(400).json({message:"expected some values to update, no values found"});let o={};return Object.keys(r==null?void 0:r.body).map(n=>{r!=null&&r.body[n]&&(o[n]=r.body[n])}),o?await Ne.findOneAndUpdate({user:t._id,_id:s},{$set:r.body})?e.json({message:"Address updated."}):e.status(400).json({message:"Address update failed"}):e.status(400).json({message:"expected some values to update, no values found"})}catch(t){return console.log(t),e.status(500).json({message:"Internal server error"})}});he.delete("/:address_item_id",Re(0,1,2),async(r,e)=>{try{let t=r.user;if(!t)return e.status(400).json({message:"Token validation failed"});let{address_item_id:s}=r.params;return console.log("address_item_id",s),await Ne.findOneAndDelete({_id:s,user:t._id})?e.json({status:!0,message:"Address deleted"}):e.status(400).json({message:"No address found with provided id!"})}catch(t){return console.log(t),e.status(500).json({status:!1,message:t.message})}});Ur.exports=he});var Br=j((jl,Vr)=>{var Ee=p("mongoose"),It=new Ee.Schema({description:{type:String,required:[!0,"Description is required"],trim:!0,minlength:[10,"Description must be at least 10 characters"],maxlength:[2e3,"Description cannot be more than 2000 characters"]},starsGiven:{type:Number,default:1,min:[1,"Rating must be at least 1"],max:[5,"Rating cannot be more than 5"],required:[!0,"Rating is required"]},product:{type:Ee.Types.ObjectId,ref:"products",required:[!0,"Product reference is required"]},givenBy:{type:String,required:[!0,"Reviewer name is required"],trim:!0},user:{type:Ee.Types.ObjectId,ref:"users",required:[!0,"User reference is required"]},productType:{type:String,enum:["buy","rent","subscription"],required:[!0,"Product type is required"]},images:[{type:Ee.Types.ObjectId,ref:"feedback_images"}],status:{type:String,enum:["pending","approved","rejected"],default:"pending"},helpfulCount:{type:Number,default:0},reportCount:{type:Number,default:0}},{timestamps:!0,toJSON:{virtuals:!0},toObject:{virtuals:!0},bufferTimeoutMS:6e4});It.index({product:1,status:1});It.index({user:1});It.index({createdAt:-1});var wi=Ee.models.feedbacks||Ee.model("feedbacks",It);Vr.exports=wi});var Gr=j((wl,Kr)=>{var us=p("mongoose"),Pi=new us.Schema({title:{type:String},thumbnailUrl:{type:String,required:!0},imageLink:{type:String,required:!0},reference:{type:String,required:!1},platform:{type:String,required:!0},uploadedBy:{type:String,required:!0}},{timestamps:!0}),Si=us.models.feedback_images||us.model("feedback_images",Pi);Kr.exports=Si});var zr=j(($l,Lr)=>{var vi=p("express"),Q=vi.Router(),Pl=p("mongoose"),qi=p("express-rate-limit"),{Product:jt}=te(),Sl=B(),H=Br(),vl=x(),be=R(),wt=Gr(),$i=p("imgbb-uploader"),ql=qi({windowMs:60*1e3,max:6,message:"Too many image uploads from this IP, please try again after a minute"}),W="feedbacks.routes.js:--";Q.get("/",be(1,2),async(r,e)=>{try{let t=r.query,s={};t!=null&&t.productId&&(s={product:t.productId});let o=t.page||1,a=t.limit||20,n=(o-1)*a,i=await H.find(s).sort({createdAt:"desc"}).skip(n).limit(a);return console.log(i),e.status(200).json({data:i||[]})}catch(t){return console.error(W,t),e.status(500).json({message:t.message})}});Q.get("/all",be(0,1,2),async(r,e)=>{try{let t={user:r.user._id},s=r.query,o=s.page||1,a=s.limit||20,n=(o-1)*a,i=await H.find(t).sort({createdAt:"desc"}).populate("product").skip(n).limit(a);return e.status(200).json({data:i||[]})}catch(t){return console.error(W,t),e.status(500).json({message:t.message})}});Q.get("/list/:productId",async(r,e)=>{try{let{productId:t}=r.params,s=r.query;if(!t)return e.status(400).json({message:"Missing required fields"});let o=s.page||1,a=s.limit||20,n=(o-1)*a,i=await H.countDocuments({product:t}),u=Math.ceil(i/a),c=await H.find({product:t}).sort({createdAt:"desc"}).populate("images").skip(n).limit(a);return console.log("Feedbacks for one product ID -->",c),e.status(200).json({feedbacks:c,totalPages:u})}catch(t){return console.error(W,t),e.status(500).json({message:t.message})}});Q.get("/:feedbackId",async(r,e)=>{try{let t=r.params;if(console.log(W,t),!t.feedbackId)return e.status(400).json({message:"Feedback ID missing!"});let s=await H.findOne({_id:t.feedbackId});return console.log(W,s),s?e.status(200).json({feedback:s}):e.status(404).json({message:"No such feedback found."})}catch(t){return console.error(W,t),e.status(500).json({message:t.message})}});Q.post("/",be(0,1,2),async(r,e)=>{var t,s;try{let{product:o,productType:a,description:n,starsGiven:i,imageIds:u}=r.body;console.log(r.body);let c=[];if(a||c.push("Product type is required"),o||c.push("Product ID is required"),n||c.push("Description is required"),(!i||i<1||i>5)&&c.push("Rating must be between 1 and 5 stars"),c.length>0)return e.status(400).json({success:!1,message:"Validation errors",errors:c});let l=await H.findOne({user:r.user._id,product:o,productType:a});if(console.log("Existing feedback ",l),l){let y=l.starsGiven,f=y!==i;return l.description=n,l.starsGiven=i,u&&u.length>0&&(await wt.updateMany({_id:{$in:u},uploadedBy:r.user._id},{feedback:l._id}),l.images=u),await l.save(),f&&await jt.updateOne({_id:o},[{$set:{totalRatings:{$add:["$totalRatings",i-y]}}},{$set:{stars:{$cond:[{$gt:["$totalFeedbacks",0]},{$round:[{$divide:["$totalRatings","$totalFeedbacks"]},2]},0]}}}]),e.status(200).json({success:!0,message:"Feedback updated successfully"})}console.log("What is users name",r.user);let m=new H({description:n,starsGiven:i,product:o,productType:a,givenBy:((t=r.user)==null?void 0:t.name)||((s=r.user)==null?void 0:s.email.split("@")[0]),user:r.user._id,images:u||[]});return await m.save(),u&&u.length>0&&await wt.updateMany({_id:{$in:u},uploadedBy:r.user._id},{feedback:m._id}),await jt.updateOne({_id:o},[{$set:{totalRatings:{$add:["$totalRatings",i]},totalFeedbacks:{$add:["$totalFeedbacks",1]}}},{$set:{stars:{$cond:[{$gt:["$totalFeedbacks",0]},{$round:[{$divide:["$totalRatings","$totalFeedbacks"]},2]},0]}}}]),e.status(201).json({success:!0,message:"Feedback submitted successfully",data:m})}catch(o){return console.error("Feedback submission error:",o),e.status(500).json({success:!1,message:"Failed to submit feedback"})}});Q.patch("/:reviewFetchBy",be(0,1,2),async(r,e)=>{var t;try{let s=(t=r.params)==null?void 0:t.reviewFetchBy,{product:o,productType:a,description:n,starsGiven:i,imageIds:u,feedbackId:c}=r.body,l=[];if(s==="product"&&!o&&l.push("Product ID is required"),n||l.push("Description is required"),(!i||i<1||i>5)&&l.push("Rating must be between 1 and 5 stars"),c||l.push("Feedback ID is required for review update"),l.length>0)return e.status(400).json({success:!1,message:"Validation errors",errors:l});let m={user:r.user._id,productType:a||"buy"};console.log("Product, product",o),o&&(m.product=o),s==="review"&&(m._id=c),console.log("Filter for feedback update",m);let y=await H.findOne(m);if(console.log("Existing feedback found for update",y),y){let f=y.starsGiven,w=f!==i;return y.description=n,y.starsGiven=i,u&&u.length>0&&(await wt.updateMany({_id:{$in:u},uploadedBy:r.user._id},{feedback:y._id}),y.images=[...u]),await y.save(),w&&await jt.updateOne({_id:y.product},[{$set:{totalRatings:{$add:["$totalRatings",i-f]}}},{$set:{stars:{$cond:[{$gt:["$totalFeedbacks",0]},{$round:[{$divide:["$totalRatings","$totalFeedbacks"]},2]},0]}}}]),e.status(200).json({success:!0,message:"Feedback updated successfully"})}return e.status(403).json({success:!1,message:"Feedback Update Failed"})}catch(s){return console.error("Feedback submission error:",s),e.status(500).json({success:!1,message:"Failed to submit feedback"})}});Q.post("/view/:fetchingId",be(0,1,2),async(r,e)=>{var t,s,o;try{let a=(t=r.params)==null?void 0:t.fetchingId,n=((s=r.body)==null?void 0:s.productType)||"buy",i=(o=r.query)==null?void 0:o.fetchBy;if(!a||!n)return e.status(400).json({message:"Missing required fields"});let u={user:r.user._id};i==="product"?u.product=a:u._id=a,console.log("Filter This One",u,i);let c=await H.findOne(u).populate("images  product");return e.status(200).json({data:c})}catch(a){return console.error(W,a),e.status(500).json({message:a.message})}});Q.delete("/delete/:feedbackId",be(0,1),async(r,e)=>{try{let t=r.params;if(console.log(W,t),!t.feedbackId)return e.status(400).json({message:"Feedback ID missing!"});let s=await H.findOne({_id:t.feedbackId,user:r.user._id});if(console.log(W,s),!s)return e.status(404).json({message:"No such feedback found."});let o=(s==null?void 0:s.starsGiven)||0;return await H.deleteOne({_id:t.feedbackId,user:r.user._id})?(console.log(W,s),await jt.updateOne({_id:s.product},[{$set:{totalRatings:{$subtract:["$totalRatings",o]},totalFeedbacks:{$cond:[{$gt:["$totalFeedbacks",0]},{$subtract:["$totalFeedbacks",1]},0]}}},{$set:{totalRatings:{$cond:[{$lt:["$totalRatings",0]},0,"$totalRatings"]}}},{$set:{stars:{$cond:[{$gt:["$totalFeedbacks",0]},{$round:[{$divide:["$totalRatings","$totalFeedbacks"]},2]},0]}}}]),e.status(200).json({message:"Feedback deleted successfully"})):e.status(400).json({message:"Delete feedback failed."})}catch(t){return console.error(W,t),e.status(500).json({message:t.message})}});Q.post("/upload-image",be(0,1,2),async(r,e)=>{var t;try{let s=(t=r.body)==null?void 0:t.imageData;if(!s)return e.status(403).json({status:!1,message:"Image Data Not Found"});let o=s.base64String.replace(/^data:image\/\w+;base64,/,""),a;try{console.log("Going for uploading the image to imagebb"),a=await $i({apiKey:process.env.IMGBB_API_KEY,base64string:o}),console.log("Upload success response",a)}catch(i){return console.error(JSON.stringify(i.response)),e.status(403).json({message:i.message})}let n;return a&&(n=new wt({title:a.title,imageLink:a.display_url,reference:a.id,platform:"imgbb",thumbnailUrl:a.display_url,uploadedBy:r.user._id}),await n.save()),n?e.status(200).json({message:"Feedback Images Uploaded",data:{...n._doc}}):e.status(400).json({status:!1,message:"Feedback Image Upload Failed"})}catch(s){return console.error(s),e.status(500).json({status:!1,message:s.message})}});Lr.exports=Q});var Ce=j((Tl,Hr)=>{var tt=p("mongoose"),Wr=new tt.Schema({user:{type:tt.Types.ObjectId,ref:"users"},centerName:{type:String,required:!0},centerImage:{type:String,required:!0},addressProofImage:{type:String,required:!0},idProofImage:{type:String,required:!0},approvedStatus:{type:String,enum:["pending","approved","rejected"],required:!0},address:{type:tt.Types.ObjectId,required:!0,ref:"addresses"},location:{type:{type:String,enum:["Point"],required:!0},coordinates:{type:[Number],required:!0}}},{timestamps:!0});Wr.index({location:"2dsphere"});var Ti=tt.models.center_details||tt.model("center_details",Wr);Hr.exports=Ti});var cs=j((Al,Jr)=>{var Yr=p("memory-cache"),Ai=async()=>{try{let r=Yr.get("shipRocketAuthToken");if(!r){let t=await(await fetch("https://apiv2.shiprocket.in/v1/external/auth/login",{method:"POST",body:JSON.stringify({email:process.env.SHIPROCKET_EMAIL,password:process.env.SHIPROCKET_PASSWORD})})).json();return Yr.put("shipRocketAuthToken",t.token,864e6),t.token}return r}catch(r){throw new Error(r)}};Jr.exports=Ai});var so=j((_l,to)=>{var _i=p("express"),Pt=_i.Router(),{v4:Qr}=p("uuid"),Zr=L(),Xr=x(),Di=Ce(),eo=B(),ki=R(),Oi=V(),{sendMail:Ni}=dt(),{Product:Ri}=te();Pt.get("/",async(r,e)=>{var t;try{let s=(t=r==null?void 0:r.jwt)==null?void 0:t.token;if(!s)return e.status(400).json({status:!1,message:"Token validation failed"});let o=eo(s);if(!o)return e.status(400).json({status:!1,message:"Token validation failed"});let a=r.query,n=a.page||1,i=a.limit||20,u=(n-1)*i,c=await Xr.find({user:o._id}).sort({createdAt:"desc"}).skip(u).limit(i).populate("paymentTxnId");return e.json({status:!0,data:c})}catch(s){return console.log(s),e.status(500).json({status:!1,message:"Internal server error!"})}});Pt.post("/:productType",ki(0,1,2),async(r,e)=>{var t,s,o;try{let a=(t=r.params)==null?void 0:t.productType;if(!a)return e.status(400).json({message:"Product Type Not Found"});let n=(s=r.query)==null?void 0:s.centerId;if(!n)return e.status(400).json({message:"Center not selected"});let i=await Zr.find({user:r.user._id,productType:a}).populate([{path:"product",select:"-productVariant"},{path:"variant",select:"-product"}]);if(!i)return e.status(400).json({message:"No items on cart"});let u=0,c=i.reduce((P,b)=>{let v,D=b.product.title;if(a==="buy"&&b.variant){let I=b.variant.discountedPrice,k=b.quantity;v=I*k,u+=b.variant.shippingPrice}else if(a==="buy"&&!b.variant){let I=b.product.discountedPrice,k=b.quantity;v=I*k,u+=b.product.shippingPrice}else if(a==="rent"&&b.variant){let I=b.variant.rentingPrice,k=b.quantity,q=b.rentDays;v=I*k*q,u+=b.variant.shippingPrice}else if(a==="rent"&&!b.variant){let I=b.product.rentingPrice,k=b.quantity,q=b.rentDays;v=I*k*q,u+=b.product.shippingPrice}return{amount:P.amount+v,productinfo:[...P.productinfo,D]}},{amount:0,productinfo:[]}),l=!0,m=500,y=!1;l&&c.amount>=m||(c.amount+=u,y=!0);let f="R_"+Qr(),w=Qr(),d;d=i.map(P=>{let b={...P,product:P.product._id,user:r.user._id,orderGroupID:w,paymentTxnId:f,title:P.product.title,quantity:P.quantity,rentDays:P.rentDays,orderType:"rent",address:null,center:n,orderStatus:"On Hold",paymentMode:"COC",shipmentType:"self_pickup"};return P.variant?(b.previewImage=P.variant.previewImage,b.price=P.variant.rentingPrice*P.rentDays*P.quantity,b.color=P.variant.color,b.size=P.variant.size):(b.previewImage=P.product.previewImage,b.price=P.product.rentingPrice*P.rentDays*P.quantity,b.color=null,b.size=null),b});let S=await Xr.insertMany(d);if(S){await Oi.create({orderGroupID:w,paymentTransactionID:f,user:r.user._id,order:S.map(v=>v._id),paymentStatus:"COC",shippingPrice:y?u:0,subTotalPrice:c.amount-(y?u:0),totalPrice:c.amount});let P=await Di.findById(n).populate("user");await Ni({from:`"Savero" <${process.env.SENDER_EMAIL_ADDRESS}>`,to:(o=P.user)==null?void 0:o.email,subject:"Savero: New Rent Order Recieved",html:`<html>
                <body>
                  <div style="width: 100%; padding: 5px 0px; display: flex; justify-content: center; align-items: center; border-bottom: 1px solid rgb(0,0,0,0.3)">
                    <h2>New Rent Order: <span style="font-size: 18px; font-weight: normal">${w}</span></h2>
                  </div>
                  <div style="padding: 40px; box-shadow: rgba(0, 0, 0, 0.16) 0px 1px 4px;">
                    <p style="font-size: 18px;">Dear ${P.user.name},</p>
                    <p style="font-size: 18px;">You have recieved new rent order with Order Group Id: ${w}. Kindly fullfill this order at the earliest possible.</p>
                  </div>
                </body>
              </html>`});let b=S.map(v=>v.product);return await Ri.updateMany({_id:{$in:b}},{$inc:{rentTotalOrders:1}}),e.status(200).json({paymentTransactionId:f,message:"Order Placed!"})}return e.status(200).json({message:"Order Could Not Be Placed!"})}catch(a){return console.log(a),e.status(500).json({status:!1,message:a.message})}});Pt.patch("/",async(r,e)=>{try{if(!(r.jwt.token||null))return e.status(400).json({status:!1,message:"Token validation failed"});let s=eo(userToken.value);if(!s)return e.status(400).json({status:!1,message:"Token validation failed"});let{productId:o,size:a,color:n}=r.body,i=new Zr({user:s._id,product:o});return a&&(i.size=a),n&&(i.color=n),await i.save(),e.json({status:!0,message:"Item added to Cart"})}catch(t){return console.log(t),e.status(500).json({status:!1,message:"Internal server error!"})}});to.exports=Pt});var oo=j((Nl,ro)=>{var Ei=p("express"),Z=Ei.Router(),oe=x(),Dl=B(),kl=Ce(),{default:Ci}=p("mongoose"),ce=R(),Ol=cs(),xi=V();Z.get("/list",ce(1,2),async(r,e)=>{var t,s;try{let o=r.query,a=+o.page||0,n=+o.limit||20,i=+a*n,u=o==null?void 0:o.orderStatus,c=o==null?void 0:o.paymentStatus,l=(t=r==null?void 0:r.jwt)==null?void 0:t.role,m={orderGroupID:{$exists:!0,$ne:null},...l===2&&{center:(s=r.jwt)==null?void 0:s.center}};c&&c!=="all"&&(m.paymentStatus=c),u&&u!=="all"&&(m.orderStatus=u);let y=[{$match:m},{$group:{_id:"$orderGroupID",totalDocumentCount:{$sum:1},totalPrice:{$sum:"$price"},paymentTransactionId:{$push:"$paymentTxnId"},paymentStatus:{$first:"$paymentStatus"},orderStatus:{$first:"$orderStatus"},orderType:{$push:"$orderType"},orders:{$push:"$$ROOT"},createdAt:{$first:"$createdAt"}}},{$addFields:{createdAt:"$createdAt"}},{$sort:{createdAt:-1}},{$group:{_id:null,globalTotalDocumentCount:{$sum:1},address:{$first:"$orders.address"},user:{$first:"$orders.user"},groupedOrders:{$push:"$$ROOT"}}},{$lookup:{from:"users",localField:"user",foreignField:"_id",pipeline:[{$match:{}},{$project:{_id:1,name:1,email:1,mobileNo:1,isMobileNoVerifed:1}}],as:"user"}},{$project:{_id:0,globalTotalDocumentCount:1,groupedOrders:{$slice:[{$map:{input:"$groupedOrders",as:"group",in:{orderGroupID:"$$group._id",totalDocumentCount:"$$group.totalDocumentCount",paymentTransactionId:{$arrayElemAt:["$$group.paymentTransactionId",0]},paymentStatus:"$$group.paymentStatus",orderStatus:"$$group.orderStatus",orderType:{$arrayElemAt:["$$group.orderType",0]},totalPrice:"$$group.totalPrice",address:{$arrayElemAt:["$address",0]},user:{$arrayElemAt:["$user",0]},orders:"$$group.orders",createdAt:"$$group.createdAt"}}},i,n]}}}],f=await oe.aggregate(y);return e.json(f[0]||{globalTotalDocumentCount:0,groupedOrders:[]})}catch(o){return console.log(o),e.status(500).json({status:!1,message:"Internal server error!"})}});Z.get("/details/:orderGroupID",ce(1,2),async(r,e)=>{var t,s,o;try{let a=(t=r.params)==null?void 0:t.orderGroupID,n=(s=r.jwt)==null?void 0:s.role,i=[{$match:{orderGroupID:a,...n===2&&{center:((o=r.jwt)==null?void 0:o.center)||"_blank"}}},{$group:{_id:"$orderGroupID",totalDocumentCount:{$sum:1},totalPrice:{$sum:"$price"},paymentTransactionId:{$push:"$paymentTxnId"},orderType:{$push:"$orderType"},orders:{$push:"$$ROOT"},createdAt:{$first:"$createdAt"}}},{$addFields:{createdAt:"$createdAt"}},{$group:{_id:null,globalTotalDocumentCount:{$sum:1},address:{$first:"$orders.address"},user:{$first:"$orders.user"},groupedOrders:{$push:"$$ROOT"}}},{$lookup:{from:"users",localField:"user",foreignField:"_id",pipeline:[{$match:{}},{$project:{_id:1,name:1,email:1,mobileNo:1,isMobileNoVerifed:1}}],as:"user"}},{$project:{_id:0,globalTotalDocumentCount:1,groupedOrders:{$map:{input:"$groupedOrders",as:"group",in:{orderGroupID:"$$group._id",totalDocumentCount:"$$group.totalDocumentCount",paymentTransactionId:{$arrayElemAt:["$$group.paymentTransactionId",0]},orderType:{$arrayElemAt:["$$group.orderType",0]},totalPrice:"$$group.totalPrice",address:{$arrayElemAt:["$address",0]},user:{$arrayElemAt:["$user",0]},orders:"$$group.orders",createdAt:"$$group.createdAt"}}}}}],u=await oe.aggregate(i);return console.log("Order Details --> ",u),e.json(u[0].groupedOrders[0])}catch(a){return console.log(a),e.status(500).json({status:!1,message:"Internal server error!"})}});Z.get("/view/:paymentTransactionId",ce(0,1,2),async(r,e)=>{var t;try{let s=(t=r.params)==null?void 0:t.paymentTransactionId,o=await xi.findOne({paymentTransactionID:s}).populate("order");return e.json({orderDetails:o})}catch(s){return console.log(s),e.status(500).json({status:!1,message:"Internal server error!"})}});Z.get("/l/:productType",ce(0,1,2),async(r,e)=>{var t;try{let s=r.query,o=(t=r.params)==null?void 0:t.productType;console.log(o);let a=s.q,n=s.page||0,i=s.limit||20,u=n*i,c,l=0,m={user:r.user._id,orderType:o};a&&(m.$text={$search:a});let y=await oe.countDocuments(m);return o==="buy"?c=await oe.find(m).sort({createdAt:"desc"}).skip(u).limit(i).populate("orderGroupID"):c=await oe.find(m).sort({createdAt:"desc"}).skip(u).limit(i),l=Math.ceil(y/i),e.json({data:c,totalPage:l})}catch(s){return console.log(s),e.status(500).json({message:"Internal server error!"})}});Z.patch("/update-status",ce(1,2),async(r,e)=>{var t,s,o,a,n;try{let i=(t=r.body)==null?void 0:t.order,u=(s=r.body)==null?void 0:s.orderStatus,c=(o=r.body)==null?void 0:o.trackingLink;if(!i||!u)return e.status(400).json({message:"Missing required fields"});let l=(a=r==null?void 0:r.jwt)==null?void 0:a.role,m=(n=r==null?void 0:r.jwt)==null?void 0:n.center,y={};if(Array.isArray(i)?y={_id:{$in:i}}:y={orderGroupID:i},y.orderStatus={$ne:"Cancelled"},l===2){if(!m)return e.status(400).json({message:"No center available for given user ID"});y.center=m}return await oe.updateMany(y,{$set:{orderStatus:u,trackingLink:c||""}}),e.json({message:"Order status updated"})}catch(i){return console.log(i),e.status(500).json({status:!1,message:"Internal server error!"})}});Z.patch("/cancel",ce(1,0),async(r,e)=>{var t;try{let s=r.user,o=(t=r.body)==null?void 0:t.orderGroupId;if(!o)return e.status(400).json({message:"Order ID is missing!"});let a={orderGroupID:o};if(s.role===0)a.user=s._id,a.orderStatus={$in:["On Hold","On Progress","Accepted"]};else if(s.role===2){let i=s==null?void 0:s.center;if(!i)return e.status(400).json({message:"No center available for given user ID"});a.center=i}return await oe.updateMany(a,{$set:{orderStatus:"Cancelled"}})?e.json({message:"Order Cancelled"}):e.json({message:"Cancellation Failed"})}catch(s){return console.log(s),e.status(500).json({status:!1,message:"Internal server error!"})}});Z.patch("/cancel-item",ce(1,0),async(r,e)=>{var t;try{let s=r.user,o=(t=r.body)==null?void 0:t.orderItemId;if(!o)return e.status(400).json({message:"Order item ID is missing!"});let a={_id:o};if(s.role===0)a.user=s._id,a.orderStatus={$in:["On Hold","On Progress","Accepted"]};else if(s.role===2){let i=s==null?void 0:s.center;if(!i)return e.status(400).json({message:"No center available for given user ID"});a.center=i}return await oe.findOneAndUpdate(a,{$set:{orderStatus:"Cancelled"}},{new:!0})?e.json({message:"Order Item Cancelled"}):e.json({message:"Cancellation Failed"})}catch(s){return console.log(s),e.status(500).json({status:!1,message:"Internal server error!"})}});Z.get("/get-order-chart-data",ce(1),async(r,e)=>{var t,s;try{let o=parseInt((t=r.query)==null?void 0:t.year),a=parseInt((s=r.query)==null?void 0:s.month),n=[{$match:{$or:[{orderStatus:"Delivered"},{orderStatus:"Cancelled"},{orderStatus:"Rejected"}]}},{$group:{_id:{year:{$year:"$updatedAt"},month:{$month:"$updatedAt"},day:{$dayOfMonth:"$updatedAt"}},deliveredCount:{$sum:{$cond:[{$eq:["$orderStatus","Delivered"]},1,0]}},cancelledCount:{$sum:{$cond:[{$eq:["$orderStatus","Cancelled"]},1,0]}},rejectedCount:{$sum:{$cond:[{$eq:["$orderStatus","Rejected"]},1,0]}}}},{$project:{_id:0,date:{$dateToString:{format:"%B %d, %Y",date:{$dateFromParts:{year:"$_id.year",month:"$_id.month",day:"$_id.day"}}}},deliveredCount:1,cancelledCount:1,rejectedCount:1,pendingCount:1}},{$sort:{date:1}},{$group:{_id:null,totalDeliveredOrders:{$sum:"$deliveredCount"},totalCancelledOrders:{$sum:"$cancelledCount"},totalRejectedOrders:{$sum:"$rejectedCount"},chartData:{$push:"$$ROOT"}}},{$project:{_id:0,totalDeliveredOrders:1,totalCancelledOrders:1,totalRejectedOrders:1,totalPendingOrders:{$subtract:[{$sum:["$totalDeliveredOrders","$totalCancelledOrders","$totalRejectedOrders"]},"$totalDeliveredOrders"]},chartData:1}}],i=await oe.aggregate(n);return e.status(200).json(i[0])}catch(o){if(console.log(o),o instanceof Ci.Error&&(o!=null&&o.errors)){let a=Object.values(o.errors).map(n=>n.message);return e.status(400).json({message:a.join(", ")})}return e.status(500).json({message:"Internal server error"})}});Z.use("/renting",so());ro.exports=Z});var no=j((Rl,ao)=>{var ds=p("mongoose"),Mi=new ds.Schema({name:{type:String,required:!0},email:{type:String,required:!0},message:{type:String,required:!0},phone:{type:Number,required:!1},readStatus:{type:Boolean,default:!1}},{timestamps:!0}),St=ds.models.messages||ds.model("messages",Mi);St.schema.path("name").validate({validator:function(r){return r.length>2},message:"name required"});St.schema.path("email").validate({validator:function(r){var e=/^[-!#$%&'*+\/0-9=?A-Z^_a-z`{|}~](\.?[-!#$%&'*+\/0-9=?A-Z^_a-z`{|}~])*@[a-zA-Z0-9](-*\.?[a-zA-Z0-9])*\.[a-zA-Z](-?[a-zA-Z0-9])+$/;return r&&e.test(r)},message:"enter valid email!"});St.schema.path("message").validate({validator:function(r){return r.length>10},message:"Message minimum length should be 10 characters"});ao.exports=St});var uo=j((El,io)=>{var{Router:Ui}=p("express"),vt=p("mongoose"),Ie=no(),qt=R(),xe=Ui();xe.get("/",qt(1,2),async(r,e)=>{var t,s,o,a;try{let n=((t=r.query)==null?void 0:t.page)||1,i=((s=r.query)==null?void 0:s.limit)||20,u=(n-1)*+i,c=await Ie.countDocuments(),l=Math.ceil(c/i),m=((o=r.query)==null?void 0:o.sortBy)||"createdAt",y=((a=r.query)==null?void 0:a.order)||"desc",f=null;return m?f=await Ie.find().sort({[m]:y}).skip(u).limit(+i):f=await Ie.find().skip(u).limit(+i),e.status(200).json({totalCounts:c,totalPages:l,messages:f})}catch(n){return console.error("Get message error => ",n),n instanceof vt.MongooseError?e.status(400).json({message:JSON.stringify(n)}):e.sendStatus(500)}});xe.get("/:id",qt(1,2),async(r,e)=>{try{let t=await Ie.findById(r.params.id);return e.status(200).json({message:t})}catch(t){return console.log("Get message error => ",t),t instanceof vt.MongooseError?e.status(400).json({message:JSON.stringify(t)}):e.sendStatus(500)}});xe.post("/create",async(r,e)=>{try{let t=new Ie(r.body);console.log(t),await t.save(),e.send({status:!0,message:"Message submitted!"})}catch(t){if(t instanceof vt.Error){let s=[];for(key in t.errors)s.push(t.errors[key].properties.message);return e.status(400).json({message:s.join(", ")})}else e.sendStatus(500)}});xe.patch("/:id/read",qt(1,2),async(r,e)=>{try{r.body._id&&delete r.body._id,console.log(r.body),await Ie.updateOne({_id:r.params.id},{$set:{readStatus:!0}},{runValidators:!1}),e.send({message:"Marked as Read!"})}catch(t){if(t instanceof vt.Error){let s=[];for(key in t.errors)s.push(t.errors[key].properties.message);e.status(400).send({status:!1,message:s.join(", ")})}else e.sendStatus(500);console.log("Patch message eror => ",t)}});xe.delete("/delete/:id",qt(1,2),async(r,e)=>{try{return await Ie.deleteOne({_id:r.params.id}),e.send({message:"Message deleted!"})}catch(t){return console.log("Delete message error => ",t),e.sendStatus(500)}});io.exports=xe});var lo=j((Cl,co)=>{var ls=p("mongoose"),Fi=new ls.Schema({clientName:{type:String,required:!0},clientSpeech:{type:String,required:!0},clientAvatar:{type:String,required:!0},clientChatImage:{type:String,required:!0}},{timestamps:!0,query:{all(){return this.where({})}}}),Vi=ls.models.testimonials||ls.model("testimonials",Fi);co.exports=Vi});var mo=j((xl,po)=>{var ps=p("mongoose"),Bi=p("express"),st=lo(),rt=Bi.Router();rt.get("/",async(r,e)=>{try{let t=r.searchQuery,s=(t==null?void 0:t.page)||1,o=(t==null?void 0:t.limit)||20,a=(s-1)*o,n=await st.countDocuments(),i=await st.find({}).sort({createdAt:"desc"}).skip(a).limit(o),u=Math.ceil(n/o);return e.status(200).json({totalPages:u,data:i,totalCount:n})}catch(t){if(console.log(t),t instanceof ps.Error){let s=[];for(let o in t.errors)s.push(t.errors[o].properties.message);return e.status(400).json({message:s.join(", ").replaceAll(" Path","")})}return e.status(500).json({message:"Internal server error"})}});rt.post("/",async(r,e)=>{var t;try{let s=(t=r.body)==null?void 0:t.testimonialData,{clientName:o,clientSpeech:a,clientAvatar:n,clientChatImage:i}=s;if(!o||!a||!n||!i)return e.status(400).json({message:"All fields are required"});let u=new st({clientName:o,clientSpeech:a,clientAvatar:n,clientChatImage:i});return await u.save(),e.status(201).json({message:"Testimonial created successfully",data:u})}catch(s){if(console.log(s),s instanceof ps.Error){let o=[];for(let a in s.errors)o.push(s.errors[a].properties.message);return e.status(400).json({message:o.join(", ").replaceAll(" Path","")})}return e.status(500).json({message:"Internal server error"})}});rt.patch("/:id",async(r,e)=>{var t;try{let{id:s}=r.params,o=(t=r.body)==null?void 0:t.testimonialData,{clientName:a,clientSpeech:n,clientAvatar:i,clientChatImage:u}=o;if(!a||!n||!i||!u)return e.status(400).json({message:"All fields are required"});let c=await st.findByIdAndUpdate(s,{clientName:a,clientSpeech:n,clientAvatar:i,clientChatImage:u},{new:!0});return c?e.status(200).json({message:"Testimonial updated successfully",data:c}):e.status(404).json({message:"Testimonial not found"})}catch(s){if(console.log(s),s instanceof ps.Error){let o=[];for(let a in s.errors)o.push(s.errors[a].properties.message);return e.status(400).json({message:o.join(", ").replaceAll(" Path","")})}return e.status(500).json({message:"Internal server error"})}});rt.delete("/:id",async(r,e)=>{try{let{id:t}=r.params,s=await st.findByIdAndDelete(t);return s?e.status(200).json({message:"Testimonial deleted successfully",data:s}):e.status(404).json({message:"Testimonial not found"})}catch(t){return console.log(t),e.status(500).json({message:"Internal server error"})}});po.exports=rt});var yo=j((Ml,go)=>{var ms=p("mongoose"),Ki=new ms.Schema({slug:{type:String,required:!0,unique:!0},title:{type:String,required:!0},description:{type:String,required:!0},shortDescription:{type:String},avatar:{type:String},cover:{type:String}},{timestamps:!0}),Gi=ms.models.dynamic_page||ms.model("dynamic_page",Ki);go.exports=Gi});var ho=j((Ul,fo)=>{var Li=p("express"),je=yo(),Me=Li.Router();Me.get("/",async(r,e)=>{try{let t=r.query,s=(t==null?void 0:t.page)||1,o=(t==null?void 0:t.limit)||20,a=(s-1)*o,n=await je.countDocuments({}),i;o===0?i=await je.find({}).sort({createdAt:"desc"}):i=await je.find({}).sort({createdAt:"desc"}).skip(a).limit(o);let u=Math.ceil(n/o);return e.status(200).json({totalPages:u,dynamicPages:i})}catch(t){return console.log(TAG,t),e.status(500).json({message:"Internal Server Error",status:!1})}});Me.post("/",async(r,e)=>{var t;try{let{slug:s,title:o,description:a,shortDescription:n,avatar:i,cover:u}=(t=r.body)==null?void 0:t.dynamicPageData;await new je({slug:s,title:o,description:a,shortDescription:n,avatar:i,cover:u}).save(),e.status(201).json({message:"Dynamic page created successfully"})}catch(s){console.error(s),e.status(500).json({message:"Error creating dynamic page",error:s})}});Me.get("/:slug",async(r,e)=>{try{let{slug:t}=r.params,s=await je.findOne({slug:t});if(!s)return e.status(404).json({message:"Page not found"});e.status(200).json(s)}catch(t){e.status(500).json({message:"Error fetching dynamic page",error:t})}});Me.patch("/:slug",async(r,e)=>{var t;try{let{slug:s}=r.params,{title:o,description:a,shortDescription:n,avatar:i,cover:u}=(t=r.body)==null?void 0:t.dynamicPageData;if(!await je.findOneAndUpdate({_id:s},{title:o,description:a,shortDescription:n,avatar:i,cover:u},{new:!0}))return e.status(404).json({message:"Page not found"});e.status(200).json({message:"Dynamic page updated successfully"})}catch(s){e.status(500).json({message:"Error updating dynamic page",error:s})}});Me.delete("/:slug",async(r,e)=>{try{let{slug:t}=r.params;if(!await je.findOneAndDelete({_id:t}))return e.status(404).json({message:"Page not found"});e.status(200).json({message:"Dynamic page deleted successfully"})}catch(t){e.status(500).json({message:"Error deleting dynamic page",error:t})}});fo.exports=Me});var Io=j((Fl,bo)=>{var $t=p("mongoose"),zi=new $t.Schema({title:{type:String,required:!0},category:{type:String,required:!0},shortDescription:{type:String,required:!0},imageUrl:{type:String,required:!0},productReference:{type:$t.Schema.ObjectId,ref:"products",required:!0}},{timestamps:!0}),Wi=$t.models.hero_product||$t.model("hero_product",zi);bo.exports=Wi});var wo=j((Vl,jo)=>{var Hi=p("express"),Tt=Io(),ot=Hi.Router();ot.post("/",async(r,e)=>{try{let{heroProductData:t}=r.body;await new Tt(t).save(),e.status(201).json({message:"Hero Product created successfully"})}catch(t){e.status(500).json({message:"Error creating hero product",error:t})}});ot.get("/",async(r,e)=>{try{let t=await Tt.find();e.status(200).json(t)}catch(t){e.status(500).json({message:"Error fetching hero products",error:t})}});ot.patch("/:id",async(r,e)=>{try{let{id:t}=r.params,{heroProductData:s}=r.body;console.log(s),await Tt.findByIdAndUpdate(t,s),e.status(200).json({message:"Hero Product updated successfully"})}catch(t){e.status(500).json({message:"Error updating hero product",error:t})}});ot.delete("/:id",async(r,e)=>{try{let{id:t}=r.params;await Tt.findByIdAndDelete(t),e.status(200).json({message:"Hero Product deleted successfully"})}catch(t){e.status(500).json({message:"Error deleting hero product",error:t})}});jo.exports=ot});var So=j((Bl,Po)=>{var Yi=p("express"),Ue=Yi.Router(),we=zt(),at=R(),nt="roles.routes.js:--";Ue.get("/",at(1,2),async(r,e)=>{try{let t=r.query,s=(t==null?void 0:t.page)||1,o=(t==null?void 0:t.limit)||20,a=(s-1)*o,n=await we.countDocuments({}),i;o===0?i=await we.find({}).sort({createdAt:"desc"}):i=await we.find({}).sort({createdAt:"desc"}).skip(a).limit(o);let u=Math.ceil(n/o);return e.status(200).json({totalPages:u,roles:i})}catch(t){return console.log(nt,t),e.status(500).json({message:"Internal Server Error",status:!1})}});Ue.post("/",at(1,2),async(r,e)=>{var t;try{let s=(t=r.body)==null?void 0:t.roleData;if(!s)return e.status(400).json({message:"Role Data Not Found"});let o=s.roleName.trim().replaceAll(" ","-").toLowerCase(),a=await we.create({roleName:s.roleName,roleNumber:s.roleNumber,roleKey:o});return e.status(200).json({message:"Role created",data:a})}catch(s){return console.error(nt,s),e.status(500).json({message:s.message})}});Ue.patch("/update/:roleId",at(1,2),async(r,e)=>{var t,s;try{let o=(t=r.params)==null?void 0:t.roleId,a=(s=r.body)==null?void 0:s.roleData;return a?o?(a.roleName&&(a.roleKey=a.roleName.trim().replaceAll(" ","-").toLowerCase()),await we.updateOne({_id:o},{$set:a}),e.status(200).json({message:"Role updated"})):e.status(400).json({message:"Role Id Not Found"}):e.status(400).json({message:"Role Data Not Found"})}catch(o){return console.error(nt,o),e.status(500).json({message:o.message})}});Ue.delete("/:roleId",at(1,2),async(r,e)=>{var t;try{let s=(t=r.params)==null?void 0:t.roleId;return s?(await we.deleteOne({_id:s}),e.status(200).json({message:"Role Deleted"})):e.status(400).json({message:"Role ID Not Found"})}catch(s){return console.error(nt,s),e.status(500).json({message:s.message})}});Ue.get("/view/:roleId",at(1,2),async(r,e)=>{var t;try{let s=(t=r.params)==null?void 0:t.roleId;if(!s)return e.status(400).json({message:"Role ID Not Found"});let o=await we.findOne({_id:s});return e.status(200).json({role:o})}catch(s){return console.error(nt,s),e.status(500).json({message:s.message})}});Po.exports=Ue});var de=j((Kl,vo)=>{var gs=p("mongoose"),Ji=new gs.Schema({code:{type:String,required:!0},minPurchasePrice:{type:Number,required:!0},off:{type:Number,required:!0},isPercentage:{type:Boolean,required:!0},description:{type:String,required:!0}}),Qi=gs.models.coupons||gs.model("coupons",Ji);vo.exports=Qi});var $o=j((Gl,qo)=>{var Zi=p("express"),Fe=Zi.Router(),ys=R(),le=de();Fe.get("/list",async(r,e)=>{try{let{page:t=1,limit:s=10}=r.query,o=(t-1)*s,a=await le.find().skip(o).limit(parseInt(s)).sort({createdAt:-1}),n=await le.countDocuments();return e.json({success:!0,coupons:a,totalPages:Math.ceil(n/s),currentPage:parseInt(t)})}catch(t){return console.error(t),e.status(500).json({message:"Server error"})}});Fe.post("/",ys(1,2),async(r,e)=>{try{let{code:t,off:s,minPurchasePrice:o,isPercentage:a,description:n}=r.body;if(!t||!n||s<=0)return e.status(400).json({message:"Invalid coupon data"});if(await le.findOne({code:t.toUpperCase()}))return e.status(400).json({message:"Coupon code already exists"});let u=new le({code:t.toUpperCase(),off:s,minPurchasePrice:o,isPercentage:a,description:n});return await u.save(),e.json({success:!0,message:"Coupon created successfully",coupon:u})}catch(t){return console.error(t),e.status(500).json({message:"Server error"})}});Fe.put("/:id",ys(1,2),async(r,e)=>{try{let{code:t,off:s,minPurchasePrice:o,isPercentage:a,description:n}=r.body,i=r.params.id;if(!t||!n||s<=0)return e.status(400).json({message:"Invalid coupon data"});let u=await le.findById(i);return u?t.toUpperCase()!==u.code&&await le.findOne({code:t.toUpperCase()})?e.status(400).json({message:"Coupon code already exists"}):(u.code=t.toUpperCase(),u.off=s,u.minPurchasePrice=o,u.isPercentage=a,u.description=n,await u.save(),e.json({success:!0,message:"Coupon updated successfully",coupon:u})):e.status(404).json({message:"Coupon not found"})}catch(t){return console.error(t),e.status(500).json({message:"Server error"})}});Fe.delete("/:id",ys(1,2),async(r,e)=>{try{let t=r.params.id;return await le.findByIdAndDelete(t)?e.json({success:!0,message:"Coupon deleted successfully"}):e.status(404).json({message:"Coupon not found"})}catch(t){return console.error(t),e.status(500).json({message:"Server error"})}});Fe.get("/validate",async(r,e)=>{try{let t=r.query.code||null;if(!t)return e.json({status:!1,message:"Coupon code is required"});let s=await le.findOne({code:t.toUpperCase()});return s?e.json({status:!0,message:"Coupon is valid",coupon:s}):e.json({status:!1,message:"Coupon not found"})}catch(t){return console.log(t),e.status(500).json({message:"Server error"})}});qo.exports=Fe});var Ao=j((Ll,To)=>{var Xi=p("express"),fs=Xi.Router(),At=Oe(),eu=R();fs.get("/",async(r,e)=>{try{let t=await At.findOne().sort({createdAt:-1});return t?e.json(t):e.status(404).json({message:"No configuration found"})}catch(t){return console.error(t),e.status(500).json({message:"Internal server error"})}});fs.post("/",eu(1,2),async(r,e)=>{try{let t=r.body;if(console.log(t),!t.brandName||!t.brandEmail||!t.address||!t.websiteUrl)return e.status(400).json({message:"Missing required fields"});let s=await At.findOne().sort({createdAt:-1});return s?s=await At.findByIdAndUpdate(s._id,{$set:t,updatedAt:Date.now()},{new:!0}):(s=new At(t),await s.save()),e.json(s)}catch(t){if(console.error(t),t instanceof mongoose.Error){let s=Object.values(t.errors).map(o=>o.message);return e.status(400).json({message:s.join(", ")})}return e.status(500).json({message:"Internal server error"})}});To.exports=fs});var ko=j((Wl,Do)=>{var tu=p("express"),Pe=tu.Router(),_o=x(),bs=M(),_t=V(),Ve=R(),zl=p("mongoose");Pe.get("/stats",Ve(1,2),async(r,e)=>{var t,s,o,a,n,i,u,c,l,m,y,f,w;try{let d=new Date,S=new Date;S.setMonth(S.getMonth()-1);let P=new Date;P.setDate(P.getDate()-7);let b=await _t.aggregate([{$match:{paymentStatus:"Paid"}},{$group:{_id:null,totalRevenue:{$sum:"$totalPrice"},lastMonthRevenue:{$sum:{$cond:[{$gte:["$createdAt",S]},"$totalPrice",0]}}}}]),v=await _t.aggregate([{$match:{paymentStatus:"Paid",createdAt:{$gte:P}}},{$group:{_id:null,total:{$sum:"$totalPrice"}}}]),D=await _o.aggregate([{$group:{_id:null,totalOrders:{$sum:1},lastMonthOrders:{$sum:{$cond:[{$gte:["$createdAt",S]},1,0]}}}}]),I=await bs.aggregate([{$group:{_id:null,totalUsers:{$sum:1},lastMonthUsers:{$sum:{$cond:[{$gte:["$createdAt",S]},1,0]}}}}]),k={revenue:{current:((t=b[0])==null?void 0:t.totalRevenue)||0,lastMonth:((s=b[0])==null?void 0:s.lastMonthRevenue)||0,change:hs(((o=b[0])==null?void 0:o.lastMonthRevenue)||0,((a=b[0])==null?void 0:a.totalRevenue)||0)},weeklySales:{current:((n=v[0])==null?void 0:n.total)||0,change:0},totalOrders:{current:((i=D[0])==null?void 0:i.totalOrders)||0,lastMonth:((u=D[0])==null?void 0:u.lastMonthOrders)||0,change:hs(((c=D[0])==null?void 0:c.lastMonthOrders)||0,((l=D[0])==null?void 0:l.totalOrders)||0)},totalUsers:{current:((m=I[0])==null?void 0:m.totalUsers)||0,lastMonth:((y=I[0])==null?void 0:y.lastMonthUsers)||0,change:hs(((f=I[0])==null?void 0:f.lastMonthUsers)||0,((w=I[0])==null?void 0:w.totalUsers)||0)}};return e.status(200).json(k)}catch(d){return console.error(d),e.status(500).json({message:"Internal server error"})}});function hs(r,e){return r===0?0:(e-r)/r*100}Pe.get("/revenue-chart",Ve(1,2),async(r,e)=>{try{let{year:t}=r.query,s=[{$match:{paymentStatus:"Paid",createdAt:{$gte:new Date(`${t}-01-01`),$lt:new Date(`${parseInt(t)+1}-01-01`)}}},{$group:{_id:{$month:"$createdAt"},totalRevenue:{$sum:"$totalPrice"}}},{$project:{_id:0,month:"$_id",totalRevenue:1}},{$sort:{month:1}}],o=await _t.aggregate(s),n=["January","February","March","April","May","June","July","August","September","October","November","December"].map((i,u)=>{let c=o.find(l=>l.month===u+1);return{month:i,revenue:c?c.totalRevenue:0}});return e.status(200).json(n)}catch(t){return console.error(t),e.status(500).json({message:"Internal server error"})}});Pe.get("/orders-chart",Ve(1,2),async(r,e)=>{try{let{year:t}=r.query,s=[{$match:{createdAt:{$gte:new Date(`${t}-01-01`),$lt:new Date(`${parseInt(t)+1}-01-01`)}}},{$group:{_id:{$month:"$createdAt"},count:{$sum:1}}},{$project:{_id:0,month:"$_id",count:1}},{$sort:{month:1}}],o=await _o.aggregate(s),n=["January","February","March","April","May","June","July","August","September","October","November","December"].map((i,u)=>{let c=o.find(l=>l.month===u+1);return{month:i,orders:c?c.count:0}});return e.status(200).json(n)}catch(t){return console.error(t),e.status(500).json({message:"Internal server error"})}});Pe.get("/users-chart",Ve(1,2),async(r,e)=>{try{let{year:t}=r.query,s=[{$match:{createdAt:{$gte:new Date(`${t}-01-01`),$lt:new Date(`${parseInt(t)+1}-01-01`)}}},{$group:{_id:{$month:"$createdAt"},count:{$sum:1}}},{$project:{_id:0,month:"$_id",count:1}},{$sort:{month:1}}],o=await bs.aggregate(s),n=["January","February","March","April","May","June","July","August","September","October","November","December"].map((i,u)=>{let c=o.find(l=>l.month===u+1);return{month:i,users:c?c.count:0}});return e.status(200).json(n)}catch(t){return console.error(t),e.status(500).json({message:"Internal server error"})}});Pe.get("/recent-transactions",Ve(1,2),async(r,e)=>{try{let t=parseInt(r.query.limit)||10,s=await _t.find({paymentStatus:"Paid"}).sort({createdAt:-1}).limit(t).populate("user","name email").populate("order");return e.status(200).json(s)}catch(t){return console.error(t),e.status(500).json({message:"Internal server error"})}});Pe.get("/new-registrations",Ve(1,2),async(r,e)=>{try{let t=parseInt(r.query.limit)||10,s=await bs.find().sort({createdAt:-1}).limit(t).select("name email mobileNo createdAt").populate("role","roleName");return e.status(200).json(s)}catch(t){return console.error(t),e.status(500).json({message:"Internal server error"})}});Do.exports=Pe});var Dt=j((Hl,Oo)=>{var Is=p("mongoose"),su=new Is.Schema({title:{type:String},thumbnailUrl:{type:String,required:!0},imageLink:{type:String,required:!0},deleteLink:{type:String,required:!1,default:""},reference:{type:String,required:!1},platform:{type:String,required:!0},uploadedBy:{type:String,required:!1,default:"none"}},{timestamps:!0,query:{all(){return this.where({})}}}),ru=Is.models.images||Is.model("images",su);Oo.exports=ru});var Eo=j((Yl,Ro)=>{var ou=p("express"),au=p("imgbb-uploader"),nu=Dt(),No=ou.Router();No.post("/upload",async(r,e)=>{var t;try{let s=(t=r.body)==null?void 0:t.imageData;if(!s)return e.status(403).json({status:!1,message:"Image Data Not Found"});let o=s.base64String.replace(/^data:image\/\w+;base64,/,""),a;try{console.log("Going for uploading the image to imagebb"),a=await au({apiKey:process.env.IMGBB_API_KEY,base64string:o}),console.log("Upload success response",a)}catch(i){return console.error(JSON.stringify(i.response)),e.status(403).json({status:!1,message:i.message})}let n;return a&&(n=await nu.create({title:a.title,imageLink:a.display_url,reference:a.id,platform:"imgbb",thumbnailUrl:a.thumb.url||a.display_url,deleteLink:a.delete_url,uploadedBy:"Test"})),n?e.status(200).json({status:!0,message:"Image uploaded"}):e.status(200).json({status:!1,message:"Image upload Failed"})}catch(s){return console.error(s),e.status(500).json({status:!1,message:s.message})}});Ro.exports=No});var Mo=j((Ql,xo)=>{var iu=p("express"),Jl=p("imgbb-uploader"),uu=p("imagekit"),{v4:cu}=p("uuid"),du=Dt(),js=iu.Router(),Co=new uu({publicKey:process.env.IMGKIT_PUBLIC_API_KEY,privateKey:process.env.IMGKIT_PRIVATE_API_KEY,urlEndpoint:process.env.IMGKIT_ENDPOINT_URL});js.post("/upload",async(r,e)=>{var t;try{let s=(t=r.body)==null?void 0:t.imageData;if(!s)return e.status(403).json({status:!1,message:"Image Data Not Found"});let o=s.base64String.replace(/^data:image\/\w+;base64,/,""),a;try{console.log("Going for uploading the image to imagekit"),a=await Co.upload({file:o,fileName:cu(),extensions:[{name:"google-auto-tagging",maxTags:5,minConfidence:95}]}),console.log("Upload success response",a)}catch(i){return console.error(JSON.stringify(i.response)),e.status(403).json({status:!1,message:i.message})}let n;return a&&(n=await du.create({title:a.name,imageLink:a.url,reference:a.fileId,platform:"imgkit",thumbnailUrl:a.thumbnailUrl||a.url,deleteLink:"",uploadedBy:"Test"})),n?e.status(200).json({status:!0,message:"Image uploaded"}):e.status(200).json({status:!1,message:"Image upload Failed"})}catch(s){return console.error(s),e.status(500).json({status:!1,message:s.message})}});js.post("/delete/:deleteId",async(r,e)=>{var t;try{let s=(t=r.query)==null?void 0:t.imageId;if(!s)return e.status(403).json({status:!1,message:"Image Data Not Found"});try{uploadResponse=await Co.deleteFile(s),console.log("Upload success response",uploadResponse)}catch(o){return console.error(JSON.stringify(o.response)),e.status(403).json({status:!1,message:o.message})}return e.status(200).json({status:!0,message:"Image uploaded"})}catch(s){return console.error(s),e.status(500).json({status:!1,message:s.message})}});xo.exports=js});var Bo=j((Zl,Vo)=>{var lu=p("express"),Uo=Dt(),Fo=lu.Router();Fo.get("/",async(r,e)=>{var t,s;try{let o=((t=r.query)==null?void 0:t.page)||1,a=((s=r.query)==null?void 0:s.limit)||50,n=(o-1)*a,i=await Uo.countDocuments(),u=await Uo.find({}).sort({createdAt:"desc"}).skip(n).limit(a),c=Math.ceil(i/a);return e.status(200).json({totalPages:c,pageLimit:parseInt(a),totalCount:i,data:u})}catch(o){return console.error(o),e.status(500).json({status:!1,message:o.message})}});Vo.exports=Fo});var Go=j((Xl,Ko)=>{var ws=p("mongoose"),pu=new ws.Schema({title:{type:String,required:!0},value:{type:String,required:!0}}),mu=ws.models.product_colors||ws.model("colors",pu);Ko.exports=mu});var Wo=j((ep,zo)=>{var gu=p("express"),Lo=gu.Router(),yu=Go(),fu=R();Lo.get("/",fu(0,1,2),async(r,e)=>{try{let t=await yu.find();return e.json({...t})}catch(t){return console.log(t),e.status(500).json({message:"Server error"})}});zo.exports=Lo});var Yo=j((tp,Ho)=>{var Ps=p("mongoose"),hu=new Ps.Schema({title:{type:String,required:!0}}),bu=Ps.models.product_sizes||Ps.model("sizes",hu);Ho.exports=bu});var Zo=j((sp,Qo)=>{var Iu=p("express"),Jo=Iu.Router(),ju=Yo(),wu=R();Jo.get("/",wu(0,1,2),async(r,e)=>{try{let t=await ju.find();return e.json({...t})}catch(t){return console.log(t),e.status(500).json({message:"Server error"})}});Qo.exports=Jo});var sa=j((rp,ta)=>{var Pu=p("express"),pe=Pu.Router(),Xo=p("bcryptjs"),Be=me(),ea=B(),Ss=M(),kt=p("mongoose"),Ke=Ce(),it=R(),{ImageUploadHelper:vs}=yt();pe.get("/list",it(1,2),async(r,e)=>{try{let t=r.query,s=t.page||0,o=t.limit||50,a=s*o,n=await Ke.countDocuments(),i=await Ke.find().sort({createdAt:"desc"}).populate(["user","address"]).skip(a).limit(o),u=Math.ceil(n/o);return e.json({centers:i,totalDocumentCount:n,totalPages:u})}catch(t){return console.log(t),e.status(500).json({message:"Internal server error!"})}});pe.get("/addresses/:userAddressID",it(0),async(r,e)=>{var t;try{let s=(t=r.params)==null?void 0:t.userAddressID;if(!s)return e.status(400).json({message:"User id is not given!"});let o=await Be.findById(s),a=await Ke.aggregate([{$geoNear:{near:{type:"Point",coordinates:o.location.coordinates},distanceField:"distance",spherical:!0,query:{approvedStatus:"approved"},key:"location"}},{$lookup:{from:"addresses",localField:"address",foreignField:"_id",as:"populatedAddress"}},{$addFields:{address:{$arrayElemAt:["$populatedAddress",0]}}},{$lookup:{from:"users",localField:"user",foreignField:"_id",as:"populatedUser"}},{$addFields:{user:{$arrayElemAt:["$populatedUser",0]}}},{$project:{populatedAddress:0,populatedUser:0,location:0}},{$sort:{distance:1}},{$limit:50}]);return a?e.json({availableCenters:a,closestCenter:a[0]}):e.status(400).json({message:"No Center Found!"})}catch(s){return console.log(s),e.status(500).json({message:"Internal server error!"})}});pe.post("/add",it(1,2),async(r,e)=>{var t;try{let s=(t=r.body)==null?void 0:t.centerData;if(!s)return e.status(400).json({message:"Center Data not found"});let o=s==null?void 0:s.name,a=s==null?void 0:s.email,n=s==null?void 0:s.mobileNo,i=s==null?void 0:s.password;let u=s==null?void 0:s.centerName,c=s==null?void 0:s.streetName,l=s==null?void 0:s.locality,m=s==null?void 0:s.postalCode,y=s==null?void 0:s.city,f=s==null?void 0:s.country,w=s==null?void 0:s.longitude,d=s==null?void 0:s.latitude;let S=s==null?void 0:s.addressProof,P=s==null?void 0:s.identityProof,b=s==null?void 0:s.centerImages;b=await vs.uploadBulkImages(b),S=await vs.uploadBulkImages(S),P=await vs.uploadBulkImages(P);let v=Xo.genSaltSync(10);i=Xo.hashSync(i,v);let D;try{D=await Ss.create({name:o,email:a,mobileNo:n,password:i,isEmailVerified:!1,isMobileNoVerified:!0,role:"65f1c3e4dd964b2b01a2ee66"})}catch(_){if(console.log(_),_ instanceof kt.Error&&(_!=null&&_.errors)){let $=Object.values(_.errors).map(g=>g.message);return e.status(400).json({message:$.join(", ")})}return e.status(400).json({message:"User creation failed!"})}let I={type:"Point",coordinates:[w,d]},k;try{k=await Be.create({user:D._id,name:"_",locality:l,city:y,postalCode:m,country:f,streetName:c,longitude:w,latitude:d,location:I})}catch(_){if(console.log(_),Ss.findByIdAndDelete(D==null?void 0:D._id),_ instanceof kt.Error&&(_!=null&&_.errors)){let $=Object.values(_.errors).map(g=>g.message);return e.status(400).json({message:$.join(", ")})}return e.status(400).json({message:"Address creation failed!"})}let q;try{q=await Ke.create({user:D._id,address:k._id,centerName:u,centerImage:b[0],addressProofImage:S[0],idProofImage:P[0],location:I,approvedStatus:"approved"})}catch(_){if(Ss.findByIdAndDelete(D==null?void 0:D._id),Be.findByIdAndDelete(k==null?void 0:k._id),_ instanceof kt.Error&&(_!=null&&_.errors)){let $=Object.values(_.errors).map(g=>g.message);return e.status(400).json({message:$.join(", ")})}return e.status(400).json({message:"Center creation failed!"})}return e.send({message:"Center created."})}catch(s){return console.error(s),e.status(500).json({message:s.message})}});pe.post("/delete",it(1,2),async(r,e)=>{var t;try{let s=(t=r.body)==null?void 0:t.centerIds;return!s||!Array.isArray(s)?e.status(400).send({message:"Center ID missing!"}):(await Ke.deleteMany({_id:{$in:s}}),e.json({message:"Deleted Successfully"}))}catch(s){return console.log(s),e.status(500).json({message:"Internal server error!"})}});pe.patch("/update/status",it(1,2),async(r,e)=>{var t,s;try{let o=(t=r.body)==null?void 0:t.centerIds,a=(s=r.body)==null?void 0:s.approvedStatus;if(!o||!Array.isArray(o))return e.status(400).send({message:"Center ID missing!"});if(!a)return e.status(400).send({message:"Status missing!"});let n=await Ke.updateMany({_id:{$in:o}},{$set:{approvedStatus:a}});return e.json({message:"Approved Successfully"})}catch(o){return console.log(o),e.status(500).json({message:"Internal server error!"})}});pe.get("/:centerId",async(r,e)=>{var t;try{let s=((t=r==null?void 0:r.jwt)==null?void 0:t.token)||null;if(!s)return e.status(400).json({status:!1,message:"Token validation failed"});let o=ea(s);return o?await Be.countDocuments({user:o._id})>=5?e.status(400).json({status:!1,message:"Address limit reached, you can only add upto 5 addresses"}):(await new Be({user:o._id,...r.body}).save(),e.json({message:"Address added."})):e.status(400).json({status:!1,message:"Token validation failed"})}catch(s){if(console.log(s),s instanceof kt.Error){let o=[];for(let a in s.errors)o.push(s.errors[a].properties.message);return e.status(400).json({message:o.join(", ").replaceAll(" Path","")})}return e.status(500).json({message:"Internal server error"})}});pe.patch("/:centerId",async(r,e)=>{try{let t=r.jwt.token||null;if(!t)return e.status(400).json({status:!1,message:"Token validation failed"});let s=ea(t);if(!s)return e.status(400).json({status:!1,message:"Token validation failed"});let{address_item_id:o}=r.params;if(!(r!=null&&r.body))return e.status(400).json({message:"expected some values to update, no values found"});let a={};return Object.keys(r==null?void 0:r.body).map(i=>{r!=null&&r.body[i]&&(a[i]=r.body[i])}),a?await Be.findOneAndUpdate({user:s._id,_id:o},{$set:r.body})?e.json({message:"Address updated."}):e.status(400).json({message:"Address update failed"}):e.status(400).json({message:"expected some values to update, no values found"})}catch(t){return console.log(t),e.status(500).json({message:"Internal server error"})}});ta.exports=pe});var ut=j((op,oa)=>{var Se=p("mongoose"),ra=new Se.Schema({orderGroupID:{type:String,required:!1},paymentTransactionID:{type:String,required:!1},user:{type:Se.Types.ObjectId,ref:"users"},orders:{type:Se.Types.ObjectId,ref:"orders"},originalPrice:{type:Number,required:!0},couponDiscountedPrice:{type:Number,default:0},appliedCoupon:{type:Se.Types.ObjectId,required:!1,ref:"coupons"},discountedPrice:{type:Number,default:0},shippingPrice:{type:Number,default:0},address:{physicalAddress:{fullName:{type:String,required:!0},phone:{type:String,required:!0},landmark:{type:String,required:!1},postalCode:{type:String,required:!0},country:{type:String,required:!0},streetName:{type:String,required:!0},city:{type:String,required:!0},state:{type:String,required:!0}},location:{type:[Number,Number],required:!1}},orderType:{type:String,required:!0,enums:["buy","rent"]},orderStatus:{type:String,default:"On Hold",enums:["On Hold","Pending","On Progress","Accepted","Rejected","Cancelled","On The Way","PickUp Ready","Delivered"]},paymentMode:{type:String,enums:["Prepaid","Cash On Delivery","Cash On Pickup"]},paymentStatus:{type:String,default:"Pending",enums:["Success","Failed","Pending"]},shipmentType:{type:String,required:!1,enums:["self_pickup","delivery_partner"],default:"self_pickup"},store:{type:Se.Types.ObjectId,required:!1,default:null},trackingLink:{type:String,default:""}},{timestamps:!0});ra.index({"$**":"text"});var Su=Se.models.order_group||Se.model("order_group",ra);oa.exports=Su});var ua=j((cp,ia)=>{var vu=p("express"),{validateWebhookSignature:qu}=p("razorpay"),qs=x(),ap=M(),{sendMail:$u}=dt(),Tu=L(),{default:np}=p("mongoose"),aa=V(),ip=me(),up=Mt(),{Product:Au}=te(),_u=ut(),Du=process.env.RAZOR_PAY_WEBHOOK_SECRET,na=vu.Router();na.post("/",async(r,e)=>{console.log("GOT AN REQUEST IN THE RAZORPAY HOOK -->");try{console.log("Raw Razorpay Request Body -->",r.body);let t=r.headers["x-razorpay-signature"];if(console.log("Webhook Signature -->",t),qu(JSON.stringify(r.body),t,Du)){let{notes:{orderGroupID:s,user:o,address:a,cartProductIds:n,productIds:i,description:u,paymentTxnId:c}}=r.body.payload.payment.entity;switch(r.body.event){case"payment.authorized":let l=[{$match:{paymentTxnId:c}},{$set:{paymentStatus:"Success",orderStatus:"On Progress"}},{$group:{_id:null,productIds:{$addToSet:"$product"},orders:{$push:"$$ROOT"}}},{$lookup:{from:"products",let:{productIds:"$productIds"},pipeline:[{$match:{$expr:{$in:["$_id","$$productIds"]}}},{$set:{buyTotalOrders:{$add:["$buyTotalOrders",1]}}}],as:"updatedProducts"}},{$project:{orders:1,updatedProducts:1}}],m=await qs.aggregate(l);if(await aa.updateOne({paymentTransactionID:c},{$set:{paymentStatus:"Paid"}}),await _u.updateOne({paymentTransactionID:c},{$set:{paymentStatus:"Paid",orderStatus:"On Progress"}}),await Tu.deleteMany({_id:{$in:n.split(",")}}),m.length>0){let{orders:y,updatedProducts:f}=m[0],w=y.map(S=>({updateOne:{filter:{_id:S._id},update:{$set:{paymentStatus:"Success",orderStatus:"On Progress"}}}})),d=f.map(S=>({updateOne:{filter:{_id:S._id},update:{$inc:{buyTotalOrders:1}}}}));await qs.bulkWrite(w),await Au.bulkWrite(d)}return await $u({from:`"${process.env.BRAND_NAME}" <${process.env.SENDER_EMAIL_ADDRESS}>`,to:process.env.OWNER_EMAIL,bcc:"nishalbarman@gmail.com",subject:"A new order recieved.",html:`<html>
                          <body>
                            <div style="width: 100%; padding: 5px 0px; display: flex; justify-content: center; align-items: center; border-bottom: 1px solid rgb(0,0,0,0.3)">
                              <h2>Hi,</h2>
                            </div>
                            <div style="padding: 40px; box-shadow: rgba(0, 0, 0, 0.16) 0px 1px 4px;">
                              <center>
                                <span style="font-size: 18px;">Hey you just got a new order, now you got some more work to do. Yo Good Luck!.
                              </center>
                            </div>
                          </body>
                        </html>`}),e.status(200).json({message:"Sucess: Status Updated"});break;case"payment.failed":return await qs.updateMany({paymentTxnId:c},{$set:{paymentStatus:"Failed",orderStatus:"Rejected"}}),await aa.updateOne({paymentTransactionID:c},{$set:{paymentStatus:"Failed"}}),e.status(200).json({message:"Failed: Status Updated"});break;default:return e.status(200).json({message:"Hook not configured for "+r.body.event})}}return e.status(200).json({message:"Signature not validated"})}catch(t){console.log(t),e.status(500).json({message:t.message})}});ia.exports=na});var pa=j((mp,la)=>{var ku=p("express"),da=ku.Router(),dp=p("https"),Ou=p("paytmchecksum"),{v4:lp}=p("uuid"),Nu=R(),Ru=M(),Eu=L(),Cu=de(),xu=x(),Mu=me(),Uu=V(),{default:Fu}=p("axios"),{resolve:pp}=p("path"),Vu=process.env.PAYTM_MKEY,ca=process.env.PAYTM_MID,Bu=process.env.PAYTM_CHANNEL_ID;da.post("/:productType",Nu(0,1,2),async(r,e)=>{var t,s;try{let o=(t=r.params)==null?void 0:t.productType,a=(s=r.body)==null?void 0:s.address,n=r.user;if(!o||!a)return e.status(400).json({message:"Parameters missing"});let i=r.query.coupon||null,u=await Eu.find({user:n._id,productType:o}).populate([{path:"product",select:"-productVariant"},{path:"variant",select:"-product"}]);if(!u)return e.status(400).json({message:"Cart is empty"});let c=0,l=[],m=u.reduce((g,h)=>{l.push(h._id);let N,C=h.product.title;if(o==="buy"&&h.variant){let A=h.variant.discountedPrice,O=h.quantity;N=A*O,c+=h.variant.shippingPrice}else if(o==="buy"&&!h.variant){let A=h.product.discountedPrice,O=h.quantity;N=A*O,c+=h.product.shippingPrice}else if(o==="rent"&&h.variant){let A=h.variant.rentingPrice,O=h.quantity,U=h.rentDays;N=A*O*U,c+=h.variant.shippingPrice}else if(o==="rent"&&!h.variant){let A=h.product.rentingPrice,O=h.quantity,U=h.rentDays;N=A*O*U,c+=h.variant.shippingPrice}return{amount:g.amount+N,productinfo:[...g.productinfo,C]}},{amount:0,productinfo:[]});if(i){let g=await Cu.findOne({_id:i});if(g){let h=g!=null&&g.isPercentage?m.amount/100*parseInt(g.off)||0:m.amount>(g.minimumPayAmount||m.amount+100)?g.off:0;m.amount-=h}}let y=!1,f=500,w=!1;y&&m.amount>=f||(m.amount+=c,w=!0);let d=m.productinfo.join(", "),S=await Mu.findById(a),P=await Ru.findById(n._id),b=generateUniqueId("PM"),v=generateUniqueId("JK"),D={};D.body={requestType:"Payment",mid:ca,websiteName:"WEBSTAGING",orderId:v,callbackUrl:"https://securegw-stage.paytm.in/theia/paytmCallback?ORDER_ID="+v,txnAmount:{value:Number(m.amount).toFixed(2).toString(),currency:"INR"},userInfo:{custId:P._id.toString(),email:P.email,firstName:P.name,mobile:P.mobileNo}},console.log(D.body);let I=await Ou.generateSignature(JSON.stringify(D.body),Vu);D.head={channelId:Bu,signature:I},console.log("Did I got the checksum",I);let k=JSON.stringify(D),q=await Fu.post(`https://securegw-stage.paytm.in/theia/api/v1/initiateTransaction?mid=${ca}&orderId=${v}`,D,{headers:{"Content-Type":"application/json","Content-Length":k.length}});console.log(q.data);let _;o==="buy"&&(_=u.map(g=>{let h={...g,product:g.product._id,user:n._id,orderGroupID:v,paymentTxnId:b,title:g.product.title,quantity:g.quantity,orderType:"buy",address:{address:{prefix:S==null?void 0:S.prefix,streetName:S.streetName,locality:S.locality,city:S.locality,state:S.locality,postalCode:S.postalCode,country:S.country},location:[S.longitude,S.latitude]},center:null,orderStatus:"Pending",paymentMode:"Prepaid",shipmentType:"delivery_partner"};return g.variant?(h.previewImage=g.variant.previewImage,h.price=g.variant.discountedPrice*g.quantity,h.shippingPrice=+g.variant.shippingPrice,h.color=g.variant.color,h.size=g.variant.size):(h.previewImage=g.product.previewImage,h.price=g.product.discountedPrice*g.quantity,h.shippingPrice=+g.product.shippingPrice,h.color=null,h.size=null),h}));let $=await xu.insertMany(_);return await Uu.create({orderGroupID:v,paymentTransactionID:b,user:n._id,order:$.map(g=>g._id),paymentStatus:"Pending",shippingPrice:w?c:0,subTotalPrice:m.amount/100-(w?c:0),totalPrice:m.amount/100}),e.status(200).json({orderId:v,txnToken:q.data.body.txnToken,amount:m.amount})}catch(o){return console.log(o),e.status(500).json({status:!1,message:o.message})}});la.exports=da});var Ot=j((gp,ma)=>{ma.exports=function(e){let t=new Date,s=t.getTime(),o=t.getFullYear();return`${e}-${s}-${o}`}});var ha=j((hp,fa)=>{var Ku=p("express"),ya=Ku.Router(),Gu=p("razorpay"),{v4:yp}=p("uuid"),Lu=R(),zu=M(),Wu=L(),Hu=de(),Yu=x(),Ju=et(),Qu=V(),ga=Ot(),fp=ut(),Zu=Oe(),Xu=process.env.RAZORPAY_KEY,ec=process.env.RAZORPAY_SECRET,tc=new Gu({key_id:Xu,key_secret:ec});ya.post("/:productType",Lu(0,1,2),async(r,e)=>{var t,s;try{let o=((t=r.params)==null?void 0:t.productType)||"buy",a=(s=r.body)==null?void 0:s.address,n=r.user;if(!o||!a)return e.status(403).json({message:"Bad Request"});let i=r.query.coupon||null;console.log("Applied coupon id is: : ",i);let u=await Wu.find({user:n._id,productType:o}).populate([{path:"product",select:"-productVariant"},{path:"variant",select:"-product"}]);if(!u)return e.status(400).json({message:"Cart is empty"});let c=0,l=[],m=u.reduce((g,h)=>{l.push(h._id);let N,C=h.product.title;if(o==="buy"&&h.variant){let A=h.variant.discountedPrice,O=h.quantity;N=A*O}else if(o==="buy"&&!h.variant){let A=h.product.discountedPrice,O=h.quantity;N=A*O}else if(o==="rent"&&h.variant){let A=h.variant.rentingPrice,O=h.quantity,U=h.rentDays;N=A*O*U}else if(o==="rent"&&!h.variant){let A=h.product.rentingPrice,O=h.quantity,U=h.rentDays;N=A*O*U}return{amount:g.amount+N,productinfo:[...g.productinfo,C]}},{amount:0,productinfo:[]}),y=m.amount,f=0,w=await Zu.findOne().sort({createdAt:-1}).select("deliveryPrice freeDeliveryAbove");w||(w={deliveryPrice:100,freeDeliveryAbove:0}),console.log(w);let d=(w==null?void 0:w.freeDeliveryAbove)>0,S=w==null?void 0:w.freeDeliveryAbove,P=!d;if(d&&m.amount>=S||(m.amount+=w.deliveryPrice,P=!0),i){let g=await Hu.findOne({_id:i});if(console.log("What are the prices after coupon: ",g,m.amount,g.minPurchasePrice,m.amount>g.minPurchasePrice),g){let h=g!=null&&g.isPercentage?m.amount/100*parseInt(g.off)||0:m.amount>g.minPurchasePrice?g.off:0;f=h,m.amount-=h,console.log("What are the prices after coupon: ",h)}}m.amount*=100;let b=m.productinfo.join(", "),v=await Ju.findById(a),D=await zu.findById(n._id),I=ga("PT"),k=ga("OD");console.log("What is the payment final amount",+m.amount);let q=await tc.orders.create({amount:parseInt(m.amount),currency:"INR",receipt:I,partial_payment:!1,notes:{orderGroupID:k,user:n._id.toString(),address:a.toString(),cartProductIds:l.join(","),productIds:u.map(g=>g.product._id).join(","),description:b,paymentTxnId:I,totalDiscountedPriceWithoutAnyCouponAndShipping:y,shippingPrice:P?c:0,couponDiscountedPrice:f}});console.log(q);let _;o==="buy"&&(_=u.map(g=>{let h={...g,product:g.product._id,user:n._id,orderGroupID:k,paymentTxnId:I,title:g.product.title,quantity:g.quantity,orderType:"buy",address:{physicalAddress:v},center:null,orderStatus:"Pending",paymentMode:"Prepaid",shipmentType:"delivery_partner"};return g.variant?(h.previewImage=g.variant.previewImage,h.price=g.variant.discountedPrice*g.quantity,h.shippingPrice=+g.variant.shippingPrice,h.color=g.variant.color,h.size=g.variant.size):(h.previewImage=g.product.previewImage,h.price=g.product.discountedPrice*g.quantity,h.shippingPrice=+g.product.shippingPrice,h.color=null,h.size=null),h}));let $=await Yu.insertMany(_);return await Qu.create({orderGroupID:k,paymentTransactionID:I,user:n._id,order:$.map(g=>g._id),paymentStatus:"Pending",shippingPrice:P?c:0,subTotalPrice:m.amount/100-(P?c:0),totalPrice:m.amount/100}),e.status(200).json({razorpayOrderId:q.id,amount:q.amount,name:n.name,email:n.email,mobileNo:n.mobileNo,productinfo:b})}catch(o){return console.log(o),e.status(500).json({status:!1,message:o.message})}});fa.exports=ya});var wa=j((wp,ja)=>{var sc=p("express"),Ia=sc.Router(),rc=p("razorpay"),{v4:bp}=p("uuid"),oc=R(),ac=M(),Ip=L(),{Product:nc,ProductVariant:ic}=te(),uc=de(),cc=x(),dc=et(),lc=V(),ba=Ot(),jp=ut(),pc=Oe(),mc=process.env.RAZORPAY_KEY,gc=process.env.RAZORPAY_SECRET,yc=new rc({key_id:mc,key_secret:gc});Ia.post("/:productType",oc(0,1,2),async(r,e)=>{var t,s,o,a,n,i,u,c,l,m,y,f;try{let w=((t=r.params)==null?void 0:t.productType)||"buy",d=((s=r.body)==null?void 0:s.productVariantId)||null,S=((o=r.body)==null?void 0:o.productId)||null,P=(a=r.body)==null?void 0:a.address,b=((n=r.body)==null?void 0:n.quantity)||1,v=r.user;if(!w||!P||!d&&!S)return e.status(403).json({message:"Bad Request"});let D=((i=r.body)==null?void 0:i.coupon)||null;console.log("Applied coupon id is: : ",D);let I=null;if(d?I=await ic.findOne({_id:d}).populate({path:"product",select:"title"}):I=await nc.findOne({_id:S}),!I)return e.status(400).json({message:"Product information is empty"});console.log("What is product data",I);let k=0,q,_=((u=I==null?void 0:I.product)==null?void 0:u.title)||(I==null?void 0:I.title);if(w==="buy"&&d){let E=I.discountedPrice,G=+b;q=E*G}else if(w==="buy"&&!d){let E=I.discountedPrice,G=+b;q=E*G}else if(w==="rent"&&d){let E=I.rentingPrice,G=+b,Et=(c=r.body)==null?void 0:c.rentDays;q=E*G*Et}else if(w==="rent"&&!d){let E=cartItem.product.rentingPrice,G=+b,Et=(l=r.body)==null?void 0:l.rentDays;q=E*G*Et}console.log("Total Price Stage One",q);let $=q,g=0,h=await pc.findOne().sort({createdAt:-1}).select("deliveryPrice freeDeliveryAbove");h||(h={deliveryPrice:100,freeDeliveryAbove:0}),console.log(h);let N=(h==null?void 0:h.freeDeliveryAbove)>0,C=h==null?void 0:h.freeDeliveryAbove,A=!N;if(N&&q>=C||(q+=h.deliveryPrice,A=!0),console.log("Total Price Stage Two",q),D){let E=await uc.findOne({_id:D});if(console.log("What are the prices after coupon: ",E,q,E.minPurchasePrice,q>E.minPurchasePrice),E){let G=E!=null&&E.isPercentage?q/100*parseInt(E.off)||0:q>E.minPurchasePrice?E.off:0;g=G,q-=G,console.log("What are the prices after coupon: ",G)}}q*=100,console.log("Coupon Applied Total Price",q);let O=(I==null?void 0:I.title)||((m=I==null?void 0:I.product)==null?void 0:m.title),U=await dc.findById(P),id=await ac.findById(v._id),ct=ba("PT"),Nt=ba("OD");console.log("What is the payment final amount",+q);let Rt=await yc.orders.create({amount:parseInt(q),currency:"INR",receipt:ct,partial_payment:!1,notes:{orderGroupID:Nt,user:v._id.toString(),address:P.toString(),cartProductIds:"NA",productIds:((y=I==null?void 0:I.product)==null?void 0:y._id)||(I==null?void 0:I._id),description:O,paymentTxnId:ct,totalDiscountedPriceWithoutAnyCouponAndShipping:$,shippingPrice:A?k:0,couponDiscountedPrice:g}});console.log(Rt);let F;if(w==="buy"){let E=null;I!=null&&I.product?E={...I==null?void 0:I.product}:E={...I},F={...E,product:((f=I==null?void 0:I.product)==null?void 0:f._id)||(I==null?void 0:I._id),user:v._id,orderGroupID:Nt,paymentTxnId:ct,title:O,quantity:+b,orderType:"buy",address:{physicalAddress:U},center:null,orderStatus:"Pending",paymentMode:"Prepaid",shipmentType:"delivery_partner"},I.product?(F.previewImage=I.previewImage,F.price=I.discountedPrice*+b,F.shippingPrice=+I.shippingPrice,F.color=I.color,F.size=I.size):(F.previewImage=I.previewImage,F.price=I.discountedPrice*+b,F.shippingPrice=+I.shippingPrice,F.color=null,F.size=null)}console.log("Order Details",F);let za=await cc.insertOne(F);return await lc.create({orderGroupID:Nt,paymentTransactionID:ct,user:v._id,order:za._id,paymentStatus:"Pending",shippingPrice:A?k:0,subTotalPrice:q/100-(A?k:0),totalPrice:q/100}),e.status(200).json({razorpayOrderId:Rt.id,amount:Rt.amount,name:v.name,email:v.email,mobileNo:v.mobileNo,productinfo:O})}catch(w){return console.log(w),e.status(500).json({status:!1,message:w.message})}});ja.exports=Ia});var va=j((qp,Sa)=>{var fc=p("express"),Pa=fc.Router(),{v4:Pp}=p("uuid"),hc=B(),bc=M(),Ic=L(),jc=de(),wc=x(),{OrderList:Sp}=x(),Pc=me(),vp=Ce(),Sc=V(),vc=process.env.STRIPE_SECRET_KEY,qc=process.env.STRIPE_PUBLISHABLE_KEY,$s=p("stripe")(vc);Pa.post("/:productType",async(r,e)=>{var t,s,o;try{let a=(t=r==null?void 0:r.jwt)==null?void 0:t.token;if(!a)return e.status(401).json({message:"No auth token provided"});let n=hc(a);if(!n)return e.status(401).json({message:"Authorization failed"});let i=(s=r.params)==null?void 0:s.productType,u=(o=r.body)==null?void 0:o.address;if(!i||!u)return e.status(400).json({message:"Parameters missing"});let c=r.query.coupon||null,l=await Ic.find({user:n._id,productType:i}).populate([{path:"product",select:"-productVariant"},{path:"variant",select:"-product"}]);if(!l)return e.status(400).json({message:"Cart is empty"});let m=0,y=[],f=l.reduce(($,g)=>{y.push(g._id);let h,N=g.product.title;if(i==="buy"&&g.variant){let C=g.variant.discountedPrice,A=g.quantity;h=C*A,m+=g.variant.shippingPrice}else if(i==="buy"&&!g.variant){let C=g.product.discountedPrice,A=g.quantity;h=C*A,m+=g.product.shippingPrice}else if(i==="rent"&&g.variant){let C=g.variant.rentingPrice,A=g.quantity,O=g.rentDays;h=C*A*O,m+=g.variant.shippingPrice}else if(i==="rent"&&!g.variant){let C=g.product.rentingPrice,A=g.quantity,O=g.rentDays;h=C*A*O,m+=g.variant.shippingPrice}return{amount:$.amount+h,productinfo:[...$.productinfo,N]}},{amount:0,productinfo:[]});if(c){let $=await jc.findOne({_id:c});if($){let g=$!=null&&$.isPercentage?f.amount/100*parseInt($.off)||0:f.amount>($.minimumPayAmount||f.amount+100)?$.off:0;f.amount-=g}}let w=!1,d=500,S=!1;w&&f.amount>=d||(f.amount+=m,S=!0),f.amount*=100;let P=f.productinfo.join(", "),b=await Pc.findById(u),v=await bc.findById(n._id);if(!v.stripeCustomer){let $=await $s.customers.create({email:v.email,name:v.name,phone:v.mobileNo});v.stripeCustomer=$}await v.save({validateBeforeSave:!1});let D=await $s.ephemeralKeys.create({customer:v.stripeCustomer.id},{apiVersion:"2024-04-10"}),I=generateUniqueId("JK"),k=await $s.paymentIntents.create({amount:f.amount,currency:"inr",customer:v.stripeCustomer.id,automatic_payment_methods:{enabled:!0},description:P,metadata:{orderGroupID:I,address:u,user:n._id.toString(),cartProductIds:y.join(","),productIds:l.map($=>$.product._id).join(",")}}),q;i==="buy"&&(q=l.map($=>{let g={...$,product:$.product._id,user:n._id,orderGroupID:I,paymentTxnId:k.id,title:$.product.title,quantity:$.quantity,orderType:"buy",address:{address:{prefix:b==null?void 0:b.prefix,streetName:b.streetName,locality:b.locality,city:b.locality,state:b.locality,postalCode:b.postalCode,country:b.country},location:[b.longitude,b.latitude]},center:null,orderStatus:"Pending",paymentMode:"Prepaid",shipmentType:"delivery_partner"};return $.variant?(g.previewImage=$.variant.previewImage,g.price=$.variant.discountedPrice*$.quantity,g.shippingPrice=+$.variant.shippingPrice,g.color=$.variant.color,g.size=$.variant.size):(g.previewImage=$.product.previewImage,g.price=$.product.discountedPrice*$.quantity,g.shippingPrice=+$.product.shippingPrice,g.color=null,g.size=null),g}));let _=await wc.insertMany(q);await Sc.create({orderGroupID:I,paymentTransactionID:k.id,user:n._id,order:_.map($=>$._id),paymentStatus:"Pending",shippingPrice:S?m:0,subTotalPrice:f.amount/100-(S?m:0),totalPrice:f.amount/100}),e.json({paymentTxnId:k.id,paymentIntent:k.client_secret,ephemeralKey:D.secret,customer:v.stripeCustomer.id,publishableKey:qc})}catch(a){return console.log(a),e.status(500).json({status:!1,message:a.message})}});Sa.exports=Pa});var Ta=j((Ap,$a)=>{var $c=p("express"),qa=$c.Router(),{v4:$p}=p("uuid"),Tc=M(),{Product:Ac,ProductVariant:_c}=te(),Dc=de(),kc=x(),Oc=me(),Tp=Ce(),Nc=V(),Rc=R(),Ec=process.env.STRIPE_SECRET_KEY,Cc=process.env.STRIPE_PUBLISHABLE_KEY,Ts=p("stripe")(Ec);qa.post("/:productType",Rc(0,1,2),async(r,e)=>{var t,s,o,a,n;try{let i=(t=r.params)==null?void 0:t.productType,u=(s=r.body)==null?void 0:s.productId,c=(o=r.body)==null?void 0:o.productVariantId,l=(a=r.body)==null?void 0:a.quantity,m=(n=r.body)==null?void 0:n.address;if(!i||!m||!u)return e.status(403).json({message:"Required fields not found"});let y=r.query.coupon||null,f=await Ac.findOne({_id:u}),w=null;c&&(w=await _c.findOne({_id:c})),console.log("Product variant",w),console.log("Product ",f);let d=0,S=0,P=f.title;if(i==="buy"&&w)d=w.discountedPrice*l,S+=w.shippingPrice;else if(i==="buy"&&!w)d=f.discountedPrice*l,S+=f.shippingPrice,console.log("I am here to go",d,S);else if(i==="rent"&&w){let A=w.rentingPrice,O=l,U=cartItem.rentDays;d=A*O*U,S+=w.shippingPrice}else if(i==="rent"&&!w){let A=f.rentingPrice,O=l,U=cartItem.rentDays;d=A*O*U,S+=w.shippingPrice}let b={amount:d,productinfo:[P]};if(y){let A=await Dc.findOne({_id:y});if(A){let O=A!=null&&A.isPercentage?b.amount/100*parseInt(A.off)||0:b.amount>(A.minimumPayAmount||b.amount+100)?A.off:0;b.amount-=O}}let v=!1,D=500,I=!1;v&&b.amount>=D||(b.amount+=S,I=!0),b.amount*=100;let k=b.productinfo.join(", "),q=await Oc.findById(m),_=await Tc.findById(r.user._id);if(!_.stripeCustomer){let A=await Ts.customers.create({email:_.email,name:_.name,phone:_.mobileNo});_.stripeCustomer=A}await _.save({validateBeforeSave:!1});let $=await Ts.ephemeralKeys.create({customer:_.stripeCustomer.id},{apiVersion:"2024-04-10"}),g=generateUniqueId("JK"),h=await Ts.paymentIntents.create({amount:b.amount,currency:"inr",customer:_.stripeCustomer.id,automatic_payment_methods:{enabled:!0},description:k,metadata:{orderGroupID:g,address:m,user:r.user._id.toString(),cartProductIds:"",productIds:f._id.toString()}}),N;i==="buy"&&(N={...f,product:f._id,user:r.user._id,orderGroupID:g,paymentTxnId:h.id,title:f.title,quantity:l,orderType:"buy",address:{address:{prefix:q==null?void 0:q.prefix,streetName:q.streetName,locality:q.locality,city:q.locality,state:q.locality,postalCode:q.postalCode,country:q.country},location:[q.longitude,q.latitude]},center:null,orderStatus:"Pending",paymentMode:"Prepaid",shipmentType:"delivery_partner"},w?(N.previewImage=w.previewImage,N.price=w.discountedPrice*item.quantity,N.shippingPrice=+w.shippingPrice,N.color=w.color,N.size=w.size):(N.previewImage=f.previewImage,N.price=f.discountedPrice*l,N.shippingPrice=+f.shippingPrice,N.color=null,N.size=null)),console.log("Created At -->",N);let C=await kc.create(N);await Nc.create({orderGroupID:g,paymentTransactionID:h.id,user:r.user._id,order:[C._id],paymentStatus:"Pending",shippingPrice:I?S:0,subTotalPrice:b.amount/100-(I?S:0),totalPrice:b.amount/100}),e.json({paymentTxnId:h.id,paymentIntent:h.client_secret,ephemeralKey:$.secret,customer:_.stripeCustomer.id,publishableKey:Cc})}catch(i){return console.log(i),e.status(500).json({status:!1,message:i.message})}});$a.exports=qa});var Da=j((_p,_a)=>{var xc=p("express"),Aa=xc.Router(),{globalErrorHandler:Mc}=Wt(),Uc=R(),Fc=V();Aa.get("/:orderGroupId",Uc(1,2),async(r,e)=>{var t;try{let s=(t=r.params)==null?void 0:t.orderGroupId;if(!s)return e.status(400).json({message:"Order Group ID missing"});let o=await Fc.findOne({orderGroupID:s}).select("paymentStatus subTotalPrice shippingPrice totalPrice");return console.log(o),e.status(200).json({paymentStatus:o.paymentStatus,subTotalPrice:o.subTotalPrice,shippingPrice:o.shippingPrice,totalPrice:o.totalPrice})}catch(s){Mc(e,s)}});_a.exports=Aa});var Na=j((Vp,Oa)=>{var Vc=p("express"),ka=Vc.Router(),Bc=p("razorpay"),{v4:Dp}=p("uuid"),kp=R(),Op=M(),Np=L(),Rp=de(),Ep=x(),Cp=et(),xp=V(),Mp=Ot(),Up=ut(),Kc=Oe(),Gc=process.env.RAZORPAY_KEY,Lc=process.env.RAZORPAY_SECRET,Fp=new Bc({key_id:Gc,key_secret:Lc});ka.get("/shipping-pricing/:productType",async(r,e)=>{var t;try{let s=((t=r.params)==null?void 0:t.productType)||"buy",o=r.user;if(!s)return e.status(403).json({message:"Bad Request"});let a=await Kc.findOne().sort({createdAt:-1}).select("deliveryPrice freeDeliveryAbove");a||(a={deliveryPrice:100,freeDeliveryAbove:0});let n=(a==null?void 0:a.freeDeliveryAbove)>0,i=a==null?void 0:a.freeDeliveryAbove;return e.status(200).json({shippingPrice:a.deliveryPrice,isFreeDeliveryAvailable:n,requiredMinimumAmountForFreeDelivery:i})}catch(s){return console.log(s),e.status(500).json({status:!1,message:s.message})}});Oa.exports=ka});var Ca=j((Bp,Ea)=>{var zc=p("express"),Wc=cs(),Hc=R(),Ra=zc.Router();Ra.get("/:orderId",Hc(0,1,2),async(r,e)=>{try{let t=r.params.orderId,s=process.env.SHIPROCKET_CHANNELID;if(!t)return e.status(400).json({message:"OrderId Missing"});if(!s)return e.status(400).json({message:"Shiprocket Channel ID Missing"});let o=await Wc(),n=await(await fetch(`https://apiv2.shiprocket.in/v1/external/courier/track?order_id=${t}&channel_id=${s}`,{method:"GET",headers:{Authorization:`Bearer ${o}`}})).json();return e.status(n.status_code||200).json(n.message?{message:n.message}:n)}catch(t){return console.error(t),e.status(500).json({message:"Internal server error"})}});Ea.exports=Ra});var Ua=j((Kp,Ma)=>{var Yc=p("express"),xa=Yc.Router(),Jc=R(),{FirebaseUtils:Qc}=p("firebase-utils");xa.post("/save-messaging-token",Jc(0,1,2),async(r,e)=>{var t,s;try{let o=(t=r.body)==null?void 0:t.firebaseMessagingToken,a=(s=r.user)==null?void 0:s._id;return await Qc.saveFirebaseTokenToDatabase({userId:a,firebaseMessagingToken:o}),e.status(200).json({message:"Token Saved"})}catch(o){return console.error(o),e.status(500).json({message:o==null?void 0:o.message})}});Ma.exports=xa});var Ba=j((Gp,Va)=>{var Zc=p("express"),Fa=Zc.Router(),Xc=p("get-image-colors");Fa.post("/",async(r,e)=>{try{let{imageUrl:t}=r.body,s=await Xc(t,{count:5}),[o,a,n,...i]=s[0]._rgb,u=`${o},${a},${n}`;return e.status(200).json({averageColor:u})}catch(t){return console.error(t),e.status(500).json({error:!0})}});Va.exports=Fa});var nd=j((Lp,La)=>{var ed=p("dotenv");ed.config();var Ga=p("express"),td=p("cors"),{rateLimit:sd}=p("express-rate-limit"),rd=p("cookie-parser"),od=Ct();od();var ad=sd({windowMs:60*1e3,limit:240,standardHeaders:"draft-7",legacyHeaders:!1,message:{message:"Take a break dear, you are sending too much requests."}}),T=Ga();T.use(td({origin:["http://localhost:5000","http://localhost:3000","https://cartshopping.in","https://bouquet.cartshopping.in","https://trishna.vercel.app","https://petal--perfection.vercel.app","https://petalperfection.cartshopping.in","https://cartshopping.in","https://www.cartshopping.in"],credentials:!0,methods:["GET","POST","PATCH","PUT","DELETE","OPTIONS"],exposedHeaders:["Set-Cookie"]}));T.use(rd());T.use(ad);T.use("/stripe/hook",Ls());T.use(Ga.json({limit:"50mb"}));T.use("/user",Js());T.use("/auth",rr());T.use("/auth/sendOtp",ur());T.use("/banners",pr());T.use("/categories",hr());T.use("/features",wr());T.use("/products",qr());T.use("/new-arrival",_r());T.use("/wishlist",kr());T.use("/cart",Er());T.use("/address",Fr());T.use("/feedbacks",zr());T.use("/orders",oo());T.use("/contact",uo());T.use("/testimonials",mo());T.use("/dynamic-pages",ho());T.use("/hero-products",wo());T.use("/roles",So());T.use("/coupons",$o());T.use("/api/web-config",Ao());T.use("/dashboard",ko());T.use("/uploader/image/imgbb",Eo());T.use("/uploader/image/imgkit",Mo());T.use("/uploader/image/list",Bo());T.use("/colors",Wo());T.use("/size",Zo());T.use("/center",sa());T.use("/hook/razorpay",ua());T.use("/pay/paytm/cart",pa());T.use("/pay/razorpay/cart",ha());T.use("/pay/razorpay/single",wa());T.use("/stripe/cart",va());T.use("/stripe/single/purchase",Ta());T.use("/payment/summary",Da());T.use("/shipping-config",Na());T.use("/shiprocket/track",Ca());T.use("/firebase",Ua());T.use("/image-bg-color",Ba());T.get("/",(r,e)=>{e.send("Hello World!")});var Ka=process.env.PORT||8e3;T.listen(Ka,()=>{console.log(`App is running on http://localhost:${Ka}`)});La.exports=T});exports. default = nd();
//! Send otp script will be written based on which otp service provider client chooses
//! CURRENTLY NOT IN USE
//! ORDER LISTING ROUTE FOR ADMIN AND CENTER
//! Order details for normal user, orders can be viewed with the transaction id
//! ORDER LISTING ROUTE FOR NORMAL USERS
//! ORDER STATUS UPDATING ROUTE CAN BE USED BY ADMIN AND CENTER
//! FROM admin panel we can get an array or signle group id. if admin selects multiple orders updation will happen based on order _id otherwise it will happen based on orderGroupID
//! ORDER CANCELLATION ROUTE CAN BE USED BY ADMIN AND NORMAL USERS
//! CANCEL INDIVIDUAL ORDER ITEM ROUTE
//! ORDER CHART DATA -- CAN BE USED BY ADMIN AND CENTER
//! RENT ORDER PLACING ROUTE FOR USER
//! User details
//! Center details
//! Images to upload
//! ORDER TRACKING DATA -- used by normal user
